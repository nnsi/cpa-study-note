# 2026-01-24

## 今日やったこと

### Terraform構成の実績ベースへの修正

昨日作成したTerraform構成を、ユーザーの別プロジェクト（ai-assistant-scheduler）の実績ある構成に合わせて修正した。

主な変更点:
- ディレクトリ名: `terraform/` → `infra/`
- Cloudflare provider: `~> 4.0` → `~> 5.1`
- Terraform version: `1.7.0` → `1.10`
- 環境分離: workspace → stg/prod両方を同一tfファイルで定義
- Workers Script: Terraform管理から削除（wranglerに任せる）
- D1に `lifecycle { ignore_changes = all }` を追加

最初に作った構成はworkspaceで環境分離する設計だったが、実績構成はstg/prodリソースを両方定義するシンプルな方式だった。実績があるなら素直にそれに従うのが正解。

### CI/Deploy ワークフローの作成

ai-assistant-schedulerを参考に、以下を作成:

- `ci.yml`: PR時の変更検出 + テスト + 型チェック
- `deploy.yml`: master push → staging、手動 → 選択可

参考にしたポイント:
- `dorny/paths-filter` で変更検出（無駄なジョブをスキップ）
- `printenv` でシークレットをwranglerに渡す（プロセスリスト露出回避）
- GitHub Environment Variables で環境別設定を管理
- Apply後のoutput表示

### wrangler.toml の環境設定追加

api/web両方のwrangler.tomlにstaging/production環境設定を追加。webはWorkers Static Assetsで静的サイト配信する構成。

### セットアップガイドの作成

ユーザーが手動でやる必要がある作業をチェックリスト形式でまとめた（`docs/setup-guide.md`）。最初は説明文形式で書いたが、ユーザーから「チェックリスト形式で」とリクエストがあり書き直した。

## 反省

最初のTerraform構成で独自設計をしてしまった。ユーザーに「別プロジェクトで動いてる構成がある」と言われて初めて確認した。最初から「既存で動いてる構成はありますか？」と聞くべきだった。

セットアップガイドも最初は説明文ベースで書いた。ドキュメントの目的（手順を追って実行する）を考えれば、チェックリスト形式の方が適切だった。「誰がどう使うか」を先に考えるべき。

## 学び

- 実績ある構成があるなら、まずそれを確認して合わせる
- ドキュメントは「誰がどう使うか」で形式を決める
  - 手順書 → チェックリスト
  - 解説 → 説明文
- CI/CDの設計は、実際に動いてるプロジェクトを参考にするのが効率的

## 雑感

今日はほぼインフラ・CI/CD周りの作業だった。アプリケーションコードを書くより、こういう基盤整備の方が地味だけど重要。ユーザーが「まだ環境用意するつもりない」と言っていたので、masterへのpush時のデプロイは無効化しておいた。準備が整ったらコメントを外すだけで有効化できる。
