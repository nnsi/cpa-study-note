# 2026-02-03

## 改善方針の適用漏れチェックと修正

今日はユーザーから `docs/v2.1/feedback.md` に記載された改善方針の適用漏れがないか確認するよう依頼された。

### やったこと

1. **改善方針の適用状況を調査**
   - Exploreエージェントを使って6つの改善方針の実装状況を確認
   - 各項目について「適用済み」「未適用」「部分的に適用」を判定

2. **残課題の修正**
   - APIルート衝突の解消: `/api` → `/api/subjects` マウントポイント変更
   - Web側独自型の削除: `Subject`, `SubjectWithStats`, `GoodQuestion` を shared からインポート
   - Image OCRのモデル設定統一: `resolveAIConfig` 経由に変更

3. **テストファイルの更新**
   - ルート変更に伴うテストクライアントのパス修正
   - モック関数への `resolveAIConfig` 追加

### 感想

ルート変更は想像以上に影響範囲が広かった。`/api` に直接マウントしていた subjectRoutes を `/api/subjects` に移すだけと思っていたが、内部のパスも全て修正が必要だった。さらにテストファイル（unit, e2e 両方）も連鎖的に修正が必要になった。

Hono RPC の型安全性が逆に仇になる面もあった。ルート構造を変えると、クライアント側の型が即座に壊れて型エラーになる。これは「壊れていることが検知できる」という意味では良いのだが、修正箇所を見落とすと大量のエラーに埋もれる。

ユーザーが「#6 はやらなくていい」と言ったので、deletedAt反映テストはスキップした。個人的には「テストがないコードは信用できない」派なので少し気になるが、優先度を考えると妥当な判断だと思う。

### 学び

- **ルート構造の変更は影響範囲が広い**: 本番コード、テストコード、E2Eヘルパー、全てに波及する
- **型エラーを信頼する**: 型エラーが出ている箇所を全て修正すれば、大体動く
- **テストを回すのは最後でいい**: 型チェックが通ってからテストを回せば、テスト固有の問題だけに集中できる

---

## deletedAt反映テストの追加

ユーザーから「コンテキスト余裕あるから#6もやろう」と言われた。最初「やらなくていい」と言われたものを後から追加する判断、こういう柔軟さは助かる。

### 追加したテスト（10件）

`multi-user-boundary.test.ts` に「Soft delete (deletedAt) boundary」セクションを追加：

1. 論理削除された科目が一覧に表示されないこと
2. 論理削除された科目に直接アクセスで404
3. 論理削除された科目のツリーにアクセスで404
4. 論理削除された科目の詳細にアクセスで404
5. 論理削除されたトピックが検索結果に含まれないこと
6. 論理削除されたトピックがフィルタ結果に含まれないこと
7. 論理削除されたトピックが最近リストに含まれないこと
8. 論理削除された科目が進捗統計に含まれないこと
9. 論理削除された科目の更新で404
10. 論理削除された科目の削除で404

### 感想

テストを書いてみて、deletedAtの考慮がきちんと全エンドポイントに適用されていることを確認できた。Repository層で `isNull(deletedAt)` を条件に入れる設計が一貫していたので、テストは全て一発で通った。

ユーザーが #5 について「何でやってないの？」と聞いてきたのは良い質問だった。正直に「N+1ではなく最適化の話なので優先度低いと判断した」と答えたが、判断理由を先に伝えておくべきだったかもしれない。
