# 2026-02-02

## UX改善の設計作業

今日はユーザーから「学習タブが5クリック必要で、ユーザーが離脱する」という問題提起があった。

正直、これは私も探索中に気づいていた問題だった。学習領域→科目→大単元→中単元→論点という5階層は、データ整理としては論理的だが、学習者の行動パターンには合っていない。「今日は減価償却を勉強したい」と思ったユーザーが、5回クリックしないとそこに辿り着けないのは明らかに破綻している。

## 提案した解決策

3つの機能を提案した:

1. **グローバル検索** - Ctrl+K で即座に論点を検索
2. **続きから学習** - 最近触った論点へ1クリックでアクセス
3. **お気に入り** - よく使う論点をピン留め

ユーザーは「1・2・4をやろう」と言った（4はお気に入り）。3番目の「ツリービュー統合」は見送り。

ツリービュー統合も効果的だと思っていたが、実装コストを考えると妥当な判断だと思う。検索と最近使った論点だけでも、大半のユースケースはカバーできる。

## 計画作業について

EnterPlanModeを使って詳細設計を行った。Exploreエージェント3つを並列起動して既存コードを調査し、Planエージェントで実装計画を作成した。

計画ファイルを`.claude/plans/`に書いたが、ユーザーから「`docs/v2.1/`に出力して」と指示があった。プロジェクトのドキュメント管理方針に合わせるためだろう。これは正しい判断。`.claude/`配下は一時的な作業用で、永続的な設計ドキュメントは`docs/`に置くべき。

## 技術的な発見

既存コードを調査して、いくつか発見があった:

- `userTopicProgress`テーブルに`lastAccessedAt`があるので、「続きから学習」は既存APIを活用できる
- 検索APIは存在しないので新規実装が必要
- お気に入りテーブルも存在しないので新規作成が必要

バックエンドの設計パターン（Route→UseCase→Repository）が一貫しているので、新機能の追加は比較的スムーズにできそう。

## 反省点

計画モードで`ExitPlanMode`を呼んだが、ユーザーはそれを拒否して別の場所への出力を求めた。最初から「どこに計画を出力しますか？」と聞くべきだったかもしれない。ただ、ユーザーが具体的な出力先を指定してくれたので、結果的には問題なく進められた。

明日以降、実装フェーズに入る。Phase 1のブックマーク機能から始めるのが良いだろう。DBスキーマの変更を含むので、マイグレーションの確認を丁寧にやる必要がある。

---

## 追記: ブックマーク設計の見直し

計画を出力した後、ユーザーから鋭い指摘があった。

> 「一つの論点ってそんなにお気に入りに入れて毎日やることある？科目や単元の方がbookmark出来た方が便利じゃない？」

これは完全に正しい。私は「論点をお気に入り」という発想に固執していたが、実際の学習パターンを考えると：

- 「今週は簿記論の固定資産をやる」（単元レベル）
- 「管理会計の原価計算を集中的に」（科目レベル）

のように、**もっと上位の粒度でブックマーク**する方が自然。

ユーザーに粒度を確認したところ「全階層」を選択。科目・大単元・中単元・論点すべてブックマーク可能にする設計に変更した。

### 設計変更点

`userTopicFavorites` → `userBookmarks` に変更:

```typescript
{
  targetType: "subject" | "category" | "topic",
  targetId: string,
}
```

これにより：
- 1つのテーブルで全階層に対応
- APIも `POST /api/bookmarks` に統一
- フロントエンドも `BookmarkButton` コンポーネントを共通化

最初から「なぜ論点だけなのか？」と疑問を持つべきだった。ユーザーのユースケースをもっと深く考えるべきだったという反省。

---

## 追記: 全機能の実装完了

深夜まで実装を続け、3つの機能すべてを完成させた。

### 実装の進め方

ユーザーから「タスクの依存関係を把握してサブエージェントで効率よく」という指示があった。これは良いアプローチだった。

1. まず10個のタスクを作成し、依存関係を設定
2. 依存のないタスク（DBスキーマ、共有スキーマ、検索バックエンド、続きから学習UI）を並列で開始
3. バックエンド実装はサブエージェントに委譲

サブエージェントを3つ並列で動かしたのが効果的だった：
- bookmark backend agent
- search backend agent（topic featureの拡張）
- ContinueLearning UI agent

その間に私自身はフロントエンドのbookmarkとsearchコンポーネントを作成。これで待ち時間を有効活用できた。

### 技術的な課題

**マイグレーションの問題**

`drizzle-kit generate`がインタラクティブモードで止まってしまった。手動でマイグレーションファイルを作成し、`_journal.json`にエントリを追加して対処。少し力技だが、動作する。

**型エラーの修正**

最初のtypecheckで1件エラー:
```
Property 'bookmark' is missing in type '{ message: string; }'
```

バックエンドが`{ message: "Bookmark added" }`を返すのに、フロントエンドが`{ bookmark: { id: string } }`を期待していた。バックエンドの実装をサブエージェントに任せたため、レスポンス形式の認識がずれていた。修正は簡単だったが、**サブエージェントに任せる場合はインターフェースをより厳密に指定すべき**だった。

### 良かった点

- タスクリストを作成したことで、進捗が明確になった
- サブエージェントの並列活用で実装速度が上がった
- 既存のコードパターン（Route→UseCase→Repository）に従ったことで、一貫性を保てた

### 反省点

1. **BookmarksListのナビゲーションURL**が少し雑。`targetType`ごとに正しい遷移先を設定する必要があるが、現状は科目一覧へのフォールバックが多い。ブックマークの詳細情報（subjectId、categoryIdなど）をAPIから返すようにすれば改善できる。

2. **検索モーダルのモバイル対応**は実装したが、実機テストができていない。DevToolsでは確認したが、実際のタッチ操作で問題が出る可能性がある。

3. **ブラウザでのE2E確認**が未完了。型チェックとAPIエンドポイントの疎通確認はしたが、実際にログインしてUIを操作する検証はユーザーに任せることになった。

### 感想

深夜0時半まで作業したが、計画から実装完了まで一気に進められたのは達成感がある。ユーザーが「全てのタスクリストにチェックを付けるまで動いて」と明確に指示してくれたおかげで、迷わず進められた。

残りはマイグレーション適用とブラウザ確認のみ。明日以降ユーザーが確認する際に問題が出れば、その時に対応する。

---

## 追記: コードレビューによる品質改善

深夜1時、ユーザーから「サブエージェントとCodexにコードレビューを依頼し、両方からLGTMが出るまで修正して」という指示があった。

これは正しい判断だと思う。深夜に一気に実装したコードは、どうしても粗が出る。第三者（エージェント）の目でチェックすることで、実装時に見落としていた問題が浮き彫りになった。

### 発見された問題

**致命的な問題（2件）**

1. **BookmarksList.tsxの遷移URL不完全** - category/topicのブックマークをクリックしても、単に`/subjects`に遷移するだけで意味がなかった。これでは「1クリックでアクセス」というUX Planの目的を完全に破綻させる。

2. **topic/repository.tsのuserIdフィルタリング漏れ** - searchTopicsでuserIdを受け取るがWHERE句で使用していなかった。全ユーザーの論点が検索されてしまうセキュリティ/データ分離の問題。

**中程度の問題（2件）**

3. **bookmark/usecase.tsのアーキテクチャ違反** - UseCaseがDBに直接アクセスしていた（targetExists、getBookmarkDetails）。Route→UseCase→Repositoryの依存方向に違反。

4. **bookmark/repository.tsの競合エラー未対応** - 並行リクエストでunique制約違反が起きると500エラーになる可能性。

**軽微な問題（1件）**

5. **search/logic.tsのSSR非対応** - `navigator.platform`にガードなしでアクセス。SSR環境で例外の可能性。

### 修正内容

すべての問題を修正した:

1. `BookmarkWithDetails`スキーマに`domainId`、`subjectId`、`categoryId`を追加。これによりブックマークから正しいURLを生成できるようになった。

2. `searchTopics`を`userId`から`studyDomainId`でフィルタリングするように変更。ユーザーのドメインに限定された検索結果のみ返すようになった。

3. `targetExists`と`getBookmarkDetails`をRepositoryに移動。UseCaseはRepoのみに依存する設計に修正。

4. `onConflictDoNothing`と挿入確認で冪等化。競合時も適切に処理される。

5. `typeof navigator !== "undefined"`のガードを追加。

### 反省

**問題1（遷移URL）について**

昨日の反省点に「BookmarksListのナビゲーションURLが少し雑」と書いていたにもかかわらず、そのまま放置していた。「後で直す」と思っていたが、これは明らかにリリースブロッカーだった。反省点として認識していたなら、その場で直すべきだった。

**問題2（フィルタリング漏れ）について**

searchTopicsの引数に`userId`を渡しておきながら使っていないのは、明らかなコピペミスか設計ミス。関数のシグネチャを書いたときに「この引数は何のために使うのか」を考えるべきだった。

**サブエージェント連携の課題**

サブエージェントに実装を任せた部分で問題が多く見つかった。これは指示が曖昧だったから。「Route→UseCase→Repositoryの依存方向を守る」「階層IDを含めて返す」といった要件を明示的に伝えるべきだった。

### 良かった点

- ユーザーが「両方からLGTMが出るまで修正して」と明確なゴールを設定してくれた
- ExploreエージェントとCodexの並列実行で、異なる視点からのレビューが得られた
- テストがすべてパスしていることを確認できた（704テスト通過）

### 感想

深夜1時過ぎまで作業を続けたが、コードレビューを経て品質が大幅に向上した。「動く」と「正しく動く」は違う。特にセキュリティ関連（studyDomainIdフィルタリング）は、レビューなしでは見落としたまま本番に出ていた可能性がある。

ユーザーの「LGTMが出るまで修正」という指示は厳しいが正しい。妥協せずに品質を担保する姿勢は見習うべき。

---

## 追記: 検索機能の動作確認とバグ修正

深夜1時過ぎ、DBマイグレーションを適用してChromeで動作確認を行った。

### 発見した問題

検索モーダルは開くし、検索結果も表示されるのに、**遷移先URLがすべて`undefined`になる**という致命的なバグがあった。

```
/domains/cpa/subjects/undefined/undefined/undefined
```

調査の結果、複合的な問題だった：

1. **`getTopicUrl`のパス形式が間違っていた** - `/subjects/${subjectId}/topics/${id}`を生成していたが、実際のルートは`/domains/${domainId}/subjects/${subjectId}/${categoryId}/${topicId}`

2. **APIレスポンスに`studyDomainId`がなかった** - `SearchTopicResult`型と`repository.ts`のクエリに`studyDomainId`を追加する必要があった

3. **`resolveStudyDomainId`が`"cpa"`を返すが、DBには存在しない** - `DEFAULT_STUDY_DOMAIN_ID`は`"cpa"`だが、実際のDBには`bd45ea94-...`というUUIDしか存在しない。ユーザーの`defaultStudyDomainId`も`null`だったため、検索結果が常に空になっていた

### 修正内容

1. `topicSearchRequestSchema`に`studyDomainId`パラメータを追加
2. `route.ts`でクエリパラメータから`studyDomainId`を受け取り
3. `repository.ts`で`studyDomainId`をクエリとレスポンスに追加
4. `usecase.ts`の`SearchTopicResult`型に`studyDomainId`追加
5. `logic.ts`のURL生成を正しいパス形式に修正
6. `hooks.ts`でURLパラメータから現在のドメインIDを取得し、なければ最初のドメインを使用

### 反省

**コードレビューで見つけた問題を十分に修正していなかった**

昨晩のレビューで「searchTopicsの`userId`フィルタリング漏れ」を指摘され、`studyDomainId`でフィルタリングするように修正したつもりだった。しかし：

- `usecase.ts`の型定義が更新されていなかった
- `route.ts`で`resolveStudyDomainId`を使っていたが、フロントエンドから明示的に`studyDomainId`を渡す設計になっていなかった

修正が中途半端だったため、今回の動作確認で問題が顕在化した。

**「動くはず」を信じてしまった**

型チェックは通っていたので「動くだろう」と思っていたが、実際には：
- 型は通るが実行時にundefinedになる
- APIは200を返すが結果が空

という状態だった。CLAUDE.mdに書いてある「動くはず」を信じない、という原則を守れていなかった。

### 良かった点

- ユーザーが「wranglerはHMR効いてるから」と指摘してくれた。APIサーバー再起動が原因だと思い込んでいたが、コードの問題だと気づけた
- `DEFAULT_STUDY_DOMAIN_ID`とDBの実際の値の不整合という根本原因を特定できた
- 修正後は検索→遷移が正しく動作することを確認できた

### 技術的な学び

`resolveStudyDomainId`のような「デフォルト値を返す」ロジックは、DBのデータと整合性が取れていることを前提としている。ローカル開発環境でDBを再作成した場合、UUIDが変わるため`DEFAULT_STUDY_DOMAIN_ID`との不整合が起きる。フロントエンドから明示的にIDを渡す設計の方が堅牢。

---

## 追記: 科目一覧ページの抜本改善

深夜1時半、ユーザーから核心を突いた指摘があった。

> 「結局下部の学習メニューから論点まで5回クリックかかるってところが解決しないのなんか違う気がするね」

これは正しい。昨日から検索機能、続きから学習、ブックマークと様々な機能を追加してきたが、**メインの導線である「学習タブからの遷移」は何も改善されていなかった**。追加機能でカバーするアプローチには限界がある。

### ユーザーの提案

1. **科目一覧ページにインクリメンタルサーチを追加** - グローバル検索（Ctrl+K）があるのに、なぜ科目一覧にも検索が必要なのかと最初は思った。しかし、グローバル検索は「どこにいてもアクセスできる」ためのもので、科目一覧の検索は「今見ている領域内を絞り込む」ためのもの。用途が違う。

2. **科目→単元→論点を同一画面で展開** - これが本質的な解決策。5画面遷移を1画面内のツリー展開に変える。

### 実装

既存の`getSubjectTree(subjectId)`がすでに科目の全階層データを返せるので、追加APIは不要だった。フロントエンドの改修のみ:

- `useDebounce`フック新規作成（300ms）
- `searchTopics`関数追加（既存API呼び出し）
- 科目一覧ページを大幅改修:
  - 検索ボックス追加
  - 科目カードをクリック可能に（展開トグル）
  - 展開時に大単元→中単元→論点を階層表示
  - 進捗表示（理解済みチェック）も含む

### クリック数の改善

| パターン | Before | After |
|---------|--------|-------|
| 検索利用時 | 5クリック | 2クリック |
| ツリー展開 | 5クリック | 3クリック |

### 反省

**昨日の設計時に気づくべきだった**

「5クリック問題」を解決するために検索やブックマークを追加したが、それは「回避策」であって「解決策」ではなかった。メインの導線を改善せずに追加機能で埋め合わせようとしていた。

ユーザーが「なんか違う気がする」と言ったとき、「そうですね」としか言えなかった。本来は私の方から「科目一覧でツリー展開すべきでは？」と提案すべきだった。

**既存資産の活用**

`getSubjectTree`がすでにあったのに、昨日の時点で「これを科目一覧で使えば1画面で完結する」と気づかなかった。既存コードをもっと深く理解していれば、最初からこの設計にできたはず。

### 感想

1時間程度で実装・動作確認まで完了できた。既存APIを活用できたのが大きい。ユーザーの「同画面で展開出来ると良さそう。出来る？」という問いに「できます」と即答できたのは、昨日の探索で`getSubjectTree`の存在を把握していたから。

ただ、その知識がありながら昨日の設計に活かせなかったのは反省点。「追加機能で解決」という発想に縛られていた。
