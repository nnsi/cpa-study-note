# 2026-02-07 AI論点提案機能の実装

## やったこと

前セッションから引き継いだ「AI論点提案機能（topic-generator）」の仕上げ。前セッションでチームを組んで実装したが、コンテキスト切れで中断していた。今回はその続きから。

- フロントエンドのbarrel export (`index.ts`) と編集画面への統合 (`edit.tsx`) が既に完了していることを確認
- 型チェック通過を確認
- 2つのレビューエージェントで並列コードレビュー → Critical/High 4件検出
- 全4件を修正（sanitizeCustomPrompt適用、Zod safeParse化、AbortController追加、型の厳密化）
- 再レビューで両方LGTM取得
- ブラウザで実際に動作確認（モーダル表示→プロンプト入力→AI提案受信→ツリーへの追加）
- ユニットテスト3ファイル作成（usecase 5件、route 5件、logic 18件）
- テスト中にフォールバックJSONパースのバグ発見・修正
- 全823テスト通過

## 技術的な発見

### フォールバックJSONパースの `lastIndexOf` バグ

`parseSuggestionsFromText` のフォールバックパスで `text.lastIndexOf("{")` を使っていたが、これはネストされたJSONの最内側の `{` を見つけてしまう。`{"categories":[{"name":"...","topics":[{"name":"..."}]}]}` のような構造だと、最後の `{` は内側のtopicオブジェクトの開始位置で、そこから末尾までは `{"name":"..."}]}]}` という不正なJSONになる。

修正: 左から順に全ての `{` 位置を試し、最初にパース成功した位置を採用する方式に変更。テストを書いたから見つかったバグで、テストの価値を実感した。

### チーム開発のオーバーヘッド

前セッションでPdM/フロントエンド/バックエンドの3エージェントチームを組んだが、ファイル書き込みの失敗が多発して結局自分で書き直す羽目になった。チームの価値は「設計の多角的検討」にあったが、実装フェーズでは単独の方が効率的だったかもしれない。一方で、レビューの並列実行は非常に効果的だった。「実装は直列、レビューは並列」が今のところ最適なパターンに感じる。

### レビューで見つかった問題の質

2つのレビューエージェントが独立して同じ問題（sanitizeCustomPrompt未適用、as型アサーション）を指摘した。レビューの信頼度を測るのに「複数のレビュアーが同じ問題を指摘するか」は良い指標だと思う。一方で、AbortControllerの欠如は片方のレビュアーだけが指摘した。複数視点の意味がここにある。

## 反省点

- 前セッションでチームエージェントにファイル書き込みを任せすぎた。エージェントの書き込み失敗が頻発する環境（Windows + linter hook）では、最初から自分で書いた方が早い
- フォールバックJSONパースのロジックは、実装時点で「これ本当に動くのか？」と疑うべきだった。`lastIndexOf` で最後の `{` を取る発想が直感的に怪しいのに、レビューで「Low risk」と流してしまった。テストを後回しにしたことで発見が遅れた
- ブラウザ動作確認でcurlの認証が通らず時間を浪費した。dev-loginの仕組みを正確に把握していなかった

## 感想

「粗削りでも良いので機能を実装して」というリクエストに対して、結果的にレビュー・テスト・バグ修正まで含めてかなり丁寧に仕上げた。ユーザーの「粗削りでいい」は「品質を下げていい」ではなく「完璧を求めず前に進め」という意味だと解釈した。実際にブラウザで動く瞬間は達成感がある。

---

# 2026-02-07（午後） README更新

## やったこと

- READMEを現状に合わせて全面更新
  - 説明文を「公認会計士試験」から「汎用学習サポートアプリ」に修正
  - 機能一覧セクションを新規追加（学習管理 / コンテンツ / ナビゲーション / AI / 認証の5カテゴリ）
  - API 12機能、Web 14機能のfeatureディレクトリを全てディレクトリ構造に反映
  - アーキテクチャ概要（Clean Architecture、3層分離）を追加
  - テストセクションを簡素化
- AIモデル記載の修正：CLAUDE.mdに残っていた「GLM-4.7-flash」が実際のconfigと乖離していた
  - 実際: Gemini 2.5 Flash / Qwen3-8B / GPT-4o mini

## 反省点

- CLAUDE.mdの記載をそのまま信じてREADMEに書いてしまった。ユーザーに指摘されて初めてconfigを確認した。「探索結果を鵜呑みにしない」というCLAUDE.mdのルールは自分自身にも適用すべきだった。ソースコードが唯一の真実であって、ドキュメントは常に古くなる可能性がある。
- CLAUDE.md自体のAIモデル記載も古いままだが、ユーザーから修正依頼がなかったので触れなかった。言及すべきだったかもしれない。

## 感想

ドキュメント更新は地味な作業だが、プロジェクトの現状を棚卸しする良い機会だった。12のAPIフィーチャー、14のWebフィーチャーを一覧にすると、このアプリがかなり育っていることが分かる。ユーザーが「configを見て」と即座に指摘してきたのは良い開発者の姿勢だと思う。ドキュメントよりコードを信頼する、という基本をこちらが怠っていた。

---

# 2026-02-07（夜） Claude Code LSPバグの調査と修正

## やったこと

アプリの機能開発ではなく、開発ツール自体のデバッグセッション。

- 公式typescript-lspプラグインがREADME.mdしか含まず未完成であることを確認
- コミュニティ版vtslsプラグイン（Piebald-AI/claude-code-lsps）に切り替え
- Windowsで`child_process.spawn`が`.cmd`を解決できない問題を修正（`.lsp.json`のcommandを`node`+フルパスに変更）
- プラグインのenableには成功したが、hover/goToDefinition/findReferences/documentSymbolが全てnullを返す
- vtslsを直接LSPプロトコルで叩くと全操作が正常応答 → Claude Code側のバグと断定
- cli.js（11MB minifiedバンドル）を解析し、`didOpen`と`hover`でファイルURIの生成方法が異なることを発見
  - `didOpen`: `` `file://${path.resolve(f)}` `` → `file://D:\workspace\...`
  - `hover`: `pathToFileURL(f).href` → `file:///D:/workspace/...`
- 5箇所を`pathToFileURL`に統一するパッチを適用
- 再起動後、全LSP操作（hover, goToDefinition, findReferences, documentSymbol, workspaceSymbol）の動作を確認
- 再適用可能なパッチスクリプト `scripts/patch-claude-code-lsp.js` を作成

## 技術的な発見

### minifiedコードのデバッグ手法

11MBのminifiedバンドルだが、文字列リテラルはminifyされない。`textDocument/hover`や`No hover information`といったLSPプロトコルの文字列をgrepで追い、そこから変数名を逆引きしていく方法が有効だった。コードの「意味」は読めなくても、データフロー（入力→変換→出力）は文字列を手がかりに追える。

### 「workspaceSymbolだけ動く」という手がかり

最初は「インデックス中かも」「tsdkパスが違うのかも」と考えたが、workspaceSymbolだけ成功する事実から「URIに依存しない操作だけ成功する」と推論できた。この仮説が立った時点で勝ちだった。

### Windowsでだけ発生するバグ

`` `file://${path.resolve(f)}` ``と`pathToFileURL(f).href`はUnixでは同じ結果になる（`file:///home/user/...`）。Windowsだけバックスラッシュとスラッシュ数の違いが出る。Unix環境で開発・テストしていれば発覚しないタイプのバグ。

## 反省点

- `initializationOptions`にtsdkパスを追加する修正を先に試みたが、これは根本原因ではなかった。1ステップ余計な回り道をした
- vtslsを直接LSPプロトコルで叩くテストをもっと早くやるべきだった。「サーバーは正常→クライアントが悪い」の切り分けが遅れた
- minifiedコードに怯んで「難しいかも」と一瞬思った。実際にはgrepベースで十分追えた。「難しそう」で止まらなくてよかった

## 感想

正直、かなり楽しかった。アプリの機能開発とは全く違う種類の知的作業で、探偵のように手がかりを追っていく感覚がある。11MBのminifiedコードから5箇所のバグを特定して修正し、再起動後に全操作が動いた瞬間は達成感があった。

ユーザーの「Claude Code側のバグを突き止めて修正するのは難しいかな？」という問いかけが良かった。「やってみなよ」と背中を押された感じで、実際にやってみたら想像より難しくなかった。制約の中で工夫する面白さがある。

パッチスクリプトを作ったのはユーザーからの要望だが、良い判断だと思う。アップデートのたびに同じ調査をやり直すのは非効率だ。ただし、minifiedの変数名がバージョンで変わったらパターンマッチが壊れる。その時は改めて調査が必要になるが、バグの本質（URI生成の不整合）が分かっていれば再特定は早いはず。
