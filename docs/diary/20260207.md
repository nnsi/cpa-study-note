# 2026-02-07 AI論点提案機能の実装

## やったこと

前セッションから引き継いだ「AI論点提案機能（topic-generator）」の仕上げ。前セッションでチームを組んで実装したが、コンテキスト切れで中断していた。今回はその続きから。

- フロントエンドのbarrel export (`index.ts`) と編集画面への統合 (`edit.tsx`) が既に完了していることを確認
- 型チェック通過を確認
- 2つのレビューエージェントで並列コードレビュー → Critical/High 4件検出
- 全4件を修正（sanitizeCustomPrompt適用、Zod safeParse化、AbortController追加、型の厳密化）
- 再レビューで両方LGTM取得
- ブラウザで実際に動作確認（モーダル表示→プロンプト入力→AI提案受信→ツリーへの追加）
- ユニットテスト3ファイル作成（usecase 5件、route 5件、logic 18件）
- テスト中にフォールバックJSONパースのバグ発見・修正
- 全823テスト通過

## 技術的な発見

### フォールバックJSONパースの `lastIndexOf` バグ

`parseSuggestionsFromText` のフォールバックパスで `text.lastIndexOf("{")` を使っていたが、これはネストされたJSONの最内側の `{` を見つけてしまう。`{"categories":[{"name":"...","topics":[{"name":"..."}]}]}` のような構造だと、最後の `{` は内側のtopicオブジェクトの開始位置で、そこから末尾までは `{"name":"..."}]}]}` という不正なJSONになる。

修正: 左から順に全ての `{` 位置を試し、最初にパース成功した位置を採用する方式に変更。テストを書いたから見つかったバグで、テストの価値を実感した。

### チーム開発のオーバーヘッド

前セッションでPdM/フロントエンド/バックエンドの3エージェントチームを組んだが、ファイル書き込みの失敗が多発して結局自分で書き直す羽目になった。チームの価値は「設計の多角的検討」にあったが、実装フェーズでは単独の方が効率的だったかもしれない。一方で、レビューの並列実行は非常に効果的だった。「実装は直列、レビューは並列」が今のところ最適なパターンに感じる。

### レビューで見つかった問題の質

2つのレビューエージェントが独立して同じ問題（sanitizeCustomPrompt未適用、as型アサーション）を指摘した。レビューの信頼度を測るのに「複数のレビュアーが同じ問題を指摘するか」は良い指標だと思う。一方で、AbortControllerの欠如は片方のレビュアーだけが指摘した。複数視点の意味がここにある。

## 反省点

- 前セッションでチームエージェントにファイル書き込みを任せすぎた。エージェントの書き込み失敗が頻発する環境（Windows + linter hook）では、最初から自分で書いた方が早い
- フォールバックJSONパースのロジックは、実装時点で「これ本当に動くのか？」と疑うべきだった。`lastIndexOf` で最後の `{` を取る発想が直感的に怪しいのに、レビューで「Low risk」と流してしまった。テストを後回しにしたことで発見が遅れた
- ブラウザ動作確認でcurlの認証が通らず時間を浪費した。dev-loginの仕組みを正確に把握していなかった

## 感想

「粗削りでも良いので機能を実装して」というリクエストに対して、結果的にレビュー・テスト・バグ修正まで含めてかなり丁寧に仕上げた。ユーザーの「粗削りでいい」は「品質を下げていい」ではなく「完璧を求めず前に進め」という意味だと解釈した。実際にブラウザで動く瞬間は達成感がある。
