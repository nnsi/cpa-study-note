# 2026-01-28 staging環境セットアップ

## やったこと

### IaC/CI周りの整備
- `setup-guide.md` の大幅な修正
  - Repository SecretsとEnvironment Secretsの使い分けを明確化
  - `GH_PAT`の作成手順を追加
  - Google OAuth設定（JavaScript origins、redirect URIs）を追加
- `infra.yml` にGitHub Environment Variables自動更新ステップを追加
  - `D1_DATABASE_ID`と`R2_BUCKET_NAME`をTerraform Apply時に自動設定
- `deploy.yml` に`API_BASE_URL`の設定漏れを発見・修正
- pnpmバージョン競合問題を修正（`package.json`の`packageManager`とGitHub Actionsの`version`）
- Durable ObjectsのFree Plan対応（`new_classes` → `new_sqlite_classes`）

### フロントエンドの認証バグ修正
- `login.tsx`でGoogleログインのリダイレクト先が相対パスになっていた問題を修正
  - `/api/auth/google` → `${VITE_API_URL}/api/auth/google`
- `chat/api.ts`のストリーミングAPIでAuthorizationヘッダーが付いていなかった問題を修正
  - Hono RPCではなく直接fetchを使っていたため、api-clientの認証ロジックがバイパスされていた

### 認証バイパスの仕様変更
- ローカル環境の認証バイパス条件を厳格化
  - 変更前: `ENVIRONMENT === "local"` で常にバイパス
  - 変更後: `ENVIRONMENT === "local" && X-Dev-User-Id ヘッダーあり` でバイパス
- これによりローカルでも本番同様の認証フローをテスト可能に
- `/api/auth/dev-login` エンドポイントは既存（トークン発行して通常認証フローを通す）

## 反省点

### setup-guide.mdの初期状態が不正確だった
最初から環境別シークレットの設定場所が間違っていた。前回のプロジェクト（ai-assistant-scheduler）を参照してようやく正しい構成を把握した。新しいプロジェクトを始める時は、過去のプロジェクトの設定を最初から確認すべきだった。

### ストリーミングAPIの認証漏れ
`chat/api.ts`で直接fetchを使っている箇所があったのに、認証ヘッダーの付与を忘れていた。「Hono RPCじゃないから別途対応が必要」という認識が抜けていた。REST APIが動いてチャットだけ動かない、という報告を受けて初めて気づいた。

### テスト修正が未完了
認証バイパスの仕様変更に伴うテスト修正を始めたが、途中でセッションが切れた。31件のテストが失敗している状態で残っている。次回セッションで対応が必要。

## 学び

### GitHub Environmentsの使い方
- Environment Secretsは環境ごとに異なる値を設定できる
- `gh api`でEnvironment Variablesを自動更新するには`GH_PAT`（Fine-grained token with Variables/Environments権限）が必要
- `GITHUB_TOKEN`ではEnvironment Variablesの更新権限がない

### Cloudflare Workers Free Planの制限
- Durable Objectsを使うには`new_sqlite_classes`マイグレーションが必須
- `new_classes`だとエラーになる

## 次回やること

1. テストの修正（`X-Dev-User-Id`ヘッダーの追加）
2. staging環境での動作確認
3. 本番環境のセットアップ
