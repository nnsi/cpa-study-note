# 2026-01-29

## AIチャット設定のクリーンアーキテクチャ分離

ユーザーから「AIチャットのモデルやプロンプトをusecaseにべた書きするの、クリーンアーキテクチャに反してない？」という指摘があった。正直、その通りだと思った。

### やったこと

- `domain/ai-config.ts`: AIConfig型とresolveAIConfig関数
- `domain/prompts.ts`: プロンプト構築関数を分離
- usecase.tsからモデル名・パラメータ・プロンプトを削除し、AIConfigを受け取る形に

### 設計判断

ユーザーの要件が段階的に明確になっていった：

1. 「将来ユーザーごとにモデルを変えたい」→ AIConfigを型として抽出
2. 「質問評価は安価なモデルで」→ chat/evaluation でモデルを分離
3. 「ローカルはdeepseek、stg/prodはglm-4.5」→ resolveAIConfig(environment)

最初から全部聞いていれば一発で設計できたが、対話的に進めたことで要件が整理されたとも言える。ユーザーも最初から全部を考えていたわけではなさそうだった。

### 反省点

モデル名を`zhipu-ai/glm-4-plus`と勝手に書いてしまった。ユーザーが「z-ai/glm-4.5」と言っているのにOpenRouterの正式名を推測で書くべきではなかった。確認してから書くべきだった。

### 感想

クリーンアーキテクチャの「依存の方向」を守ることの価値を改めて感じた。UseCaseがインフラ詳細（モデル名）を知らない状態にすることで、環境切り替えやユーザープラン分岐といった拡張が自然にできるようになった。

プロンプトをdomain層に置くかどうかは議論の余地がある。プロンプトは「ビジネスルールの表現」とも言えるのでdomainに置いたが、モデル固有の調整が入る場合はadapter層の方が適切かもしれない。今回はモデル非依存のプロンプトなのでdomain層で問題ないと判断した。
