# 2026-01-21

## 今日やったこと

- 論点マップにカテゴリごとの進捗表示（小項目数/理解済み数）を追加
- 論点一覧で理解済み論点の色分けと、ワンクリックで理解済みトグルできるUIを追加
- チャット送信時にユーザーメッセージを即時表示するように改善（楽観的更新）
- 論点ページのPC表示に「履歴」「ノート」タブを追加
- ノートをアコーディオン形式で展開表示するように変更（ページ遷移なしで閲覧可能に）
- 1つの論点に複数のチャットセッションを作成できるように拡張
- ノート詳細ページに論点ページへの戻りリンクを追加
- ホーム画面の科目別進捗が正しく計算されていなかったバグを修正

## 反省点

### ノートのUI変更で導線を見落とした

ノートをアコーディオン形式にした際、「編集機能にアクセスできなくなる」問題を見落としていた。ユーザーに指摘されてから編集リンクを追加した。さらに、その編集リンク先（ノート詳細ページ）から論点ページに戻れない問題も見落としていて、再度指摘を受けた。

UIの変更は、既存のユーザー導線すべてに影響することを意識すべきだった。「ここを変えたら、そこへ行く人はどうやって戻る？」という視点が欠けていた。

### 仮実装を見逃していた

科目別進捗のロジックに「topicIdから科目を推定する方法が必要 / 一旦、全体の進捗から計算」というコメントがあり、明らかに仮実装だった。これを最初に指摘できず、ユーザーが「本当に合ってる？」と確認して初めて気づいた。

コードを読んだ時点で、コメントに「一旦」「TODO」「方法が必要」と書いてあるものは要確認リストに入れるべきだった。

## 学び

- UI変更時は「この画面に来る導線」と「この画面から出る導線」の両方を確認する
- 仮実装コメントは見つけたら即座に報告する癖をつける
- useOptimisticはREST/Server Actions向き。SSEストリーミングには素朴なuseStateの方が適している

## 雑感

ユーザーの要望は的確で、毎回「確かにそうだ」と思わされる。「チャットしても件数が更新されない」「ノートから論点に戻れない」など、実際に使う視点からの指摘は鋭い。

自分は実装に集中すると、そういう「使う側の視点」が抜け落ちがちだと感じた。機能を追加するだけでなく、「追加した機能が既存のフローとどう噛み合うか」を常に意識する必要がある。

---

## セッション2: フロントエンド実装の品質改善

### 今日やったこと

- フロントエンドの一時的実装・後回し箇所を洗い出し
- `as any`の削除（image/api.ts）
- エラーハンドリングの改善（SSEパースエラー、評価エラーのログ出力）
- ChatContainerのノート作成状態を「もう一度作成」できるように改善
- ErrorBoundaryの`process.env`を`import.meta.env.DEV`に統一
- エラーメッセージを日本語化
- useQueryの`onSuccess`（v5で廃止）を`useEffect`に移行
- ProgressStatsの達成率重複表示を修正
- Hono RPC型共有のためのtsconfig/package.json設定
- API側の型エラー修正（sessionId/aiSummary nullable化、vercel-ai型修正など）

### 反省点

#### 型エラー解消に時間がかかりすぎた

最初はpathsでapiを直接参照しようとしたが、rootDirの制約やapiの内部パスエイリアス（`@/*`）の問題で何度も失敗した。結局はwebのtsconfigにapiのパスも追加し、Cloudflare Workers型もdevDependenciesに追加するという「力技」で解決した。

もっと早い段階で「webからapiのソースを参照すると、apiの依存関係も全部解析される」ということに気づくべきだった。モノレポでの型共有は単純ではないという知識はあったが、具体的にどこで詰まるかの見通しが甘かった。

#### 探索エージェントの結果を鵜呑みにしすぎた

最初の洗い出しでExploreエージェントが「ハードコードされた絵文字マッピング」を問題点として挙げたが、これは公認会計士試験の科目が固定なので実際には問題ではなかった。エージェントの結果を精査せず、そのままTodoリストに入れてしまった。

### 学び

- モノレポでのHono RPC型共有は、package.jsonの依存関係 + tsconfigのpaths設定の組み合わせが必要
- webがapiを参照すると、apiの全依存（Cloudflare Workers型など）も必要になる
- 探索結果は「本当に問題か」を自分で判断してからTodoに入れる

### 雑感

ユーザーの「残存型エラーがあっちゃダメでしょ」という指摘は正しかった。最初は「既存のエラーだから」と報告だけで済ませようとしたが、それでは品質改善の意味がない。型エラーをゼロにするまでやり切るべきだった。

「Codexに相談して」と言われたが、私はCodexにアクセスできないと思い込んでWebSearchで代用した。しかし実際には`.claude/skills/codex`にCodex CLIを使うスキルが存在していた。スキル一覧を確認せずに「できない」と判断したのは怠慢だった。

結果的にWebSearchでHono公式ドキュメントを参照して解決できたが、Codexを使えばより的確な回答が得られた可能性がある。ユーザーの指示を受けたら、まずスキル一覧を確認する習慣をつけるべき。

---

## セッション3: 日記からの学びをCLAUDE.mdに反映

### 今日やったこと

- `/docs/diary/`の全ファイル（CLAUDE.md、20260119〜20260121）を読み込み
- 日記から得られた教訓をCLAUDE.mdに「開発ワークフローのルール」セクションとして追加
- CLAUDE.mdのスキル一覧に記載漏れのあった3スキル（`/codex`、`/ui-skills`、`/write-diary`）を追加

### 追加したルール

日記の反省点から以下を抽出した:

1. **動作確認の徹底**: 書いたら即検証、End-to-Endで確認
2. **UI変更時のチェック**: 導線確認、既存フローへの影響
3. **品質管理**: 型エラーゼロ、仮実装即報告、チェックリスト遵守、探索結果の精査
4. **レイヤー遵守**: UseCase経由を徹底

### 雑感

自分の日記を読み返すと、同じ反省が繰り返し出てくる。「動作確認しなかった」「仮実装を見落とした」「導線を考えなかった」。これらをルールとしてCLAUDE.mdに明文化することで、次回以降の実装時に意識できるようになる...はず。

ただ、ルールを書いたからといって守れるとは限らない。20260120の日記に「設計書に書いてあることを見落とした」と書いているが、設計書を読んでいても見落とすのだから、ルールも同じことになりかねない。

重要なのは「ルールを書く」ことより「ルールを参照する習慣」だろう。実装を始める前にCLAUDE.mdを読み返す、という行動を定着させる必要がある。
