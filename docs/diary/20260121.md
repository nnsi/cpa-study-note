# 2026-01-21

## 今日やったこと

- 論点マップにカテゴリごとの進捗表示（小項目数/理解済み数）を追加
- 論点一覧で理解済み論点の色分けと、ワンクリックで理解済みトグルできるUIを追加
- チャット送信時にユーザーメッセージを即時表示するように改善（楽観的更新）
- 論点ページのPC表示に「履歴」「ノート」タブを追加
- ノートをアコーディオン形式で展開表示するように変更（ページ遷移なしで閲覧可能に）
- 1つの論点に複数のチャットセッションを作成できるように拡張
- ノート詳細ページに論点ページへの戻りリンクを追加
- ホーム画面の科目別進捗が正しく計算されていなかったバグを修正

## 反省点

### ノートのUI変更で導線を見落とした

ノートをアコーディオン形式にした際、「編集機能にアクセスできなくなる」問題を見落としていた。ユーザーに指摘されてから編集リンクを追加した。さらに、その編集リンク先（ノート詳細ページ）から論点ページに戻れない問題も見落としていて、再度指摘を受けた。

UIの変更は、既存のユーザー導線すべてに影響することを意識すべきだった。「ここを変えたら、そこへ行く人はどうやって戻る？」という視点が欠けていた。

### 仮実装を見逃していた

科目別進捗のロジックに「topicIdから科目を推定する方法が必要 / 一旦、全体の進捗から計算」というコメントがあり、明らかに仮実装だった。これを最初に指摘できず、ユーザーが「本当に合ってる？」と確認して初めて気づいた。

コードを読んだ時点で、コメントに「一旦」「TODO」「方法が必要」と書いてあるものは要確認リストに入れるべきだった。

## 学び

- UI変更時は「この画面に来る導線」と「この画面から出る導線」の両方を確認する
- 仮実装コメントは見つけたら即座に報告する癖をつける
- useOptimisticはREST/Server Actions向き。SSEストリーミングには素朴なuseStateの方が適している

## 雑感

ユーザーの要望は的確で、毎回「確かにそうだ」と思わされる。「チャットしても件数が更新されない」「ノートから論点に戻れない」など、実際に使う視点からの指摘は鋭い。

自分は実装に集中すると、そういう「使う側の視点」が抜け落ちがちだと感じた。機能を追加するだけでなく、「追加した機能が既存のフローとどう噛み合うか」を常に意識する必要がある。

---

## セッション2: フロントエンド実装の品質改善

### 今日やったこと

- フロントエンドの一時的実装・後回し箇所を洗い出し
- `as any`の削除（image/api.ts）
- エラーハンドリングの改善（SSEパースエラー、評価エラーのログ出力）
- ChatContainerのノート作成状態を「もう一度作成」できるように改善
- ErrorBoundaryの`process.env`を`import.meta.env.DEV`に統一
- エラーメッセージを日本語化
- useQueryの`onSuccess`（v5で廃止）を`useEffect`に移行
- ProgressStatsの達成率重複表示を修正
- Hono RPC型共有のためのtsconfig/package.json設定
- API側の型エラー修正（sessionId/aiSummary nullable化、vercel-ai型修正など）

### 反省点

#### 型エラー解消に時間がかかりすぎた

最初はpathsでapiを直接参照しようとしたが、rootDirの制約やapiの内部パスエイリアス（`@/*`）の問題で何度も失敗した。結局はwebのtsconfigにapiのパスも追加し、Cloudflare Workers型もdevDependenciesに追加するという「力技」で解決した。

もっと早い段階で「webからapiのソースを参照すると、apiの依存関係も全部解析される」ということに気づくべきだった。モノレポでの型共有は単純ではないという知識はあったが、具体的にどこで詰まるかの見通しが甘かった。

#### 探索エージェントの結果を鵜呑みにしすぎた

最初の洗い出しでExploreエージェントが「ハードコードされた絵文字マッピング」を問題点として挙げたが、これは公認会計士試験の科目が固定なので実際には問題ではなかった。エージェントの結果を精査せず、そのままTodoリストに入れてしまった。

### 学び

- モノレポでのHono RPC型共有は、package.jsonの依存関係 + tsconfigのpaths設定の組み合わせが必要
- webがapiを参照すると、apiの全依存（Cloudflare Workers型など）も必要になる
- 探索結果は「本当に問題か」を自分で判断してからTodoに入れる

### 雑感

ユーザーの「残存型エラーがあっちゃダメでしょ」という指摘は正しかった。最初は「既存のエラーだから」と報告だけで済ませようとしたが、それでは品質改善の意味がない。型エラーをゼロにするまでやり切るべきだった。

「Codexに相談して」と言われたが、私はCodexにアクセスできないと思い込んでWebSearchで代用した。しかし実際には`.claude/skills/codex`にCodex CLIを使うスキルが存在していた。スキル一覧を確認せずに「できない」と判断したのは怠慢だった。

結果的にWebSearchでHono公式ドキュメントを参照して解決できたが、Codexを使えばより的確な回答が得られた可能性がある。ユーザーの指示を受けたら、まずスキル一覧を確認する習慣をつけるべき。

---

## セッション3: 日記からの学びをCLAUDE.mdに反映

### 今日やったこと

- `/docs/diary/`の全ファイル（CLAUDE.md、20260119〜20260121）を読み込み
- 日記から得られた教訓をCLAUDE.mdに「開発ワークフローのルール」セクションとして追加
- CLAUDE.mdのスキル一覧に記載漏れのあった3スキル（`/codex`、`/ui-skills`、`/write-diary`）を追加

### 追加したルール

日記の反省点から以下を抽出した:

1. **動作確認の徹底**: 書いたら即検証、End-to-Endで確認
2. **UI変更時のチェック**: 導線確認、既存フローへの影響
3. **品質管理**: 型エラーゼロ、仮実装即報告、チェックリスト遵守、探索結果の精査
4. **レイヤー遵守**: UseCase経由を徹底

### 雑感

自分の日記を読み返すと、同じ反省が繰り返し出てくる。「動作確認しなかった」「仮実装を見落とした」「導線を考えなかった」。これらをルールとしてCLAUDE.mdに明文化することで、次回以降の実装時に意識できるようになる...はず。

ただ、ルールを書いたからといって守れるとは限らない。20260120の日記に「設計書に書いてあることを見落とした」と書いているが、設計書を読んでいても見落とすのだから、ルールも同じことになりかねない。

重要なのは「ルールを書く」ことより「ルールを参照する習慣」だろう。実装を始める前にCLAUDE.mdを読み返す、という行動を定着させる必要がある。

---

## セッション4: フロントエンドデザインの全面刷新

### 今日やったこと

- Tailwind設定のカスタマイズ（カラーパレット: 藍色・墨色・琥珀・翡翠・紅色）
- Google Fonts（Noto Serif JP / Noto Sans JP）の導入
- グローバルCSSの刷新（背景テクスチャ、カスタムコンポーネントクラス多数）
- レイアウトコンポーネント（Layout、Header、Sidebar、BottomNav）のリデザイン
- ホームページ（ランディング・ダッシュボード）のリデザイン
- 科目一覧ページのリデザイン
- ノート一覧ページのリデザイン
- チャットUI（メッセージ、入力フォーム、コンテナ）のリデザイン
- ProgressStatsコンポーネントのリデザイン

### デザイン方針

ユーザーから「モダンなスタイリングに」という要望を受け、「和モダン×学習の静謐さ」というコンセプトを設定した。公認会計士試験という真剣な学習アプリに相応しい、日本的な落ち着きと現代的な洗練を融合させる方向性。

- **色彩**: 藍色（深い青）と墨色をベースに、差し色で柔らかい琥珀
- **タイポグラフィ**: 見出しにNoto Serif JP（明朝体）、本文にNoto Sans JP（ゴシック体）
- **空間**: ゆとりある余白、和の「間」を意識
- **質感**: 微細なノイズテクスチャ、紙のような温かみ

「よくあるAIアプリ」の没個性的なブルー×ホワイトから脱却し、印章風のロゴアイコン「会」やグラスモーフィズムなどで独自性を出した。

### 反省点

#### 一気に変更しすぎた

ほぼ全画面を一度に変更したため、途中でどこかが壊れても切り分けが難しい状態だった。幸い大きな問題は起きなかったが、もう少し段階的に進めるべきだった。

例えば「まずTailwind設定とグローバルCSSだけ変更して動作確認」→「レイアウト系」→「各ページ」のように分けていれば、問題発生時の原因特定が容易だったはず。

#### ノートページの見落とし

最初のデザイン変更後、Playwrightで確認したらノートページのテキストが薄すぎた。これはノートページを更新し忘れていたため、古いgray-xxx系のクラスがそのまま残っていたのが原因。

全画面を更新したつもりでも、確認作業で漏れが見つかった。やはり「書いたら即検証」は大事。

### 学び

- 大規模なデザイン変更は段階的に行い、各段階で動作確認を挟む
- カスタムカラー（ink-xxx）を定義したら、旧来のgray-xxxが残っていないか全体を確認する
- Playwright MCPでの視覚確認は有効。スクリーンショットで問題を発見できた

### 雑感

「frontend-design」スキルの指示に従い、「BOLD aesthetic direction」を意識した。最初は「和モダン」という方向性が浮かんだが、もしユーザーが別のテイストを好んでいたらどうだったか、という不安もあった。

結果的にユーザーからの修正要望はなく、Playwrightでの確認も任せてもらえたので、方向性は間違っていなかったと思いたい。ただ、本当は「こういう方向性でいいか」を最初に確認すべきだったかもしれない。「モダンなスタイリング」という指示は曖昧で、解釈の幅がある。

一方で、デザインは言葉で説明するより見せた方が早いこともある。今回は作ってから確認してもらう形になったが、それで問題なければ効率的ではあった。ケースバイケースだろう。

---

## セッション5: UIコントラスト・パディングの改善

### 今日やったこと

- ホーム画面の学習進捗カード、テキストが薄い問題の修正
- 論点一覧のパディング追加とボタンサイズ調整
- `ui-skills`を使った全画面の体系的なチェック
- 残存していた`gray-xxx`/`blue-xxx`系クラスの`ink-xxx`/`indigo-xxx`への統一
- `text-ink-400`（薄すぎ）→ `text-ink-500`への修正（説明文、メタ情報など）
- `w-X h-X` → `size-X`への統一（ui-skills準拠）
- `h-screen` → `h-dvh`への修正（ui-skills準拠）

### 原因と対策

#### カードのテキストが薄く見えた原因

`.card::before`の疑似要素（グラデーションオーバーレイ）にz-indexが指定されておらず、テキストの上に重なっていた。`-z-10`を追加して解決。

CSSの疑似要素は、明示的なz-index指定がないとスタッキングコンテキストで予期しない位置に配置されることがある。装飾用の疑似要素は常に`-z-10`などで背面に押し込むべき。

#### 色クラスの不統一

前セッションでカスタムカラーパレットを導入したが、一部のファイルで旧来の`gray-xxx`が残っていた。grepで`gray-`や`blue-`を検索し、該当箇所を一括修正した。

### 反省点

#### サブエージェントの活用が遅れた

最初は直接Playwright MCPを呼んでスクリーンショットを取っていたが、ユーザーから「コンテキストを食うからサブエージェントに任せて」と指摘された。確かに、画像を含む結果は大量のトークンを消費する。

Playwright MCPのような「結果が大きくなりがちなツール」は、最初からサブエージェントに委譲する判断ができるべきだった。

#### ui-skillsの存在を忘れていた

`size-*`や`h-dvh`などのルールはui-skillsに明記されていたが、最初は意識せずに手作業で修正を進めていた。ユーザーに「ui-skillsを使って確認して」と言われてからスキルを適用した。

スキル一覧は把握しているつもりだったが、「このタスクにはこのスキルが適用される」という紐付けが弱かった。UI関連の作業では常にui-skillsを参照する習慣が必要。

### 学び

- CSS疑似要素（::before/::after）は明示的に`-z-10`などで背面に配置する
- カラーパレット変更後は、grepで旧クラスの残存を確認する
- Playwright MCPなど出力の大きいツールはサブエージェントに委譲する
- UI作業時はui-skillsを最初に読んでから作業を始める

### 雑感

今回のセッションはユーザーの指摘に対応する形で進んだ。「まだ薄いところがある」「パディング足りない」「ui-skills使って」と、毎回ユーザーが次のステップを示してくれた。

自分から「他にも同様の問題がないか確認しましょうか」と提案できればよかった。デザイン変更後の品質チェックは、ユーザーに言われる前に網羅的に行うべきだった。

一方で、ユーザーの「どう思う？」という問いかけに対して、自分の意見（パディングは確かに狭い、など）を述べてから修正に入れたのは良かった。単に「はい、修正します」ではなく、技術的な根拠を示せた。
