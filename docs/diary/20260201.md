# 2026-02-01

## 今日やったこと

v2「汎用勉強サポートアプリ」への移行設計を行った。

## 設計プロセスの振り返り

最初の設計ドキュメント作成は比較的スムーズだった。既存コードベースを調査したところ、思った以上に汎用的に設計されていて、「公認会計士」に特化している箇所は限定的だった。これはv1の設計が良かったということだろう。

ExploreエージェントとCodexによるレビューを複数回実施した。最初のレビューで指摘された問題点：

- `subjects.name` の UNIQUE 制約が複数学習領域対応を阻害
- SQLite/D1 の NOT NULL 制約追加の困難さ
- `buildSystemPrompt()` の JOIN パターン未設計

これらは確かに見落としていた。特にSQLiteの制約については、普段PostgreSQLを想定して設計しがちなので、D1特有の制限を意識できていなかった。

## コードの分離について

ユーザーから「設計の中にコードが紛れ込むのはgrep検索の際に邪魔になる」という指摘があった。これは正しい指摘だと思う。

最初は設計ドキュメントに「実装イメージがわかりやすいように」とコード例を多く入れていた。しかし：

1. 設計と実装の境界が曖昧になる
2. コードが変更されたときに乖離が発生する
3. 検索ノイズになる

という問題がある。`design.md`（方針）と `implementation-guide.md`（コード例）に分離したのは良い判断だったと思う。

## Codexとのやりとり

Codexに「軽微な指摘は不要、LGTMかブロッカーのみ回答せよ」と伝えるようユーザーから指示があった。確かにCodexは細かい改善提案を多く出す傾向があり、それ自体は有用だが、承認プロセスを長引かせる原因にもなる。

「承認可能」「実装に進んで問題ない」という評価が出ても、提案が並んでいると「まだ修正が必要なのでは」という印象を与えてしまう。レビュアーへの指示の出し方は重要だと学んだ。

## 設計で気になっていること

`/d/` というURLプレフィックスについて、Codexは「短縮のためとあるが、SEO・可読性のトレードオフ」と指摘していた。私も `/domains/` の方が明示的で良いと思うが、ユーザーが採用を決めたのでそれに従った。URL設計は後から変更しづらいので、この判断が正しかったかは時間が経ってみないとわからない。

また、学習領域離脱時に学習履歴を保持するという方針は「痕跡を残す」思想に合致しているが、将来的にGDPR対応などで「完全削除」が求められた場合にどうするか、という観点は抜けている。今回の設計スコープ外だが、頭の片隅には置いておきたい。

## 所要時間

セッション全体で約2時間。レビュー→修正→再レビューのサイクルを3回ほど回した。

---

## v2 タスクリスト作成（セッション2）

設計ドキュメントをもとに `docs/v2/tasks.md` を作成した。

### やったこと

1. design.md と implementation-guide.md からタスクを抽出し、5フェーズに分類
2. サブエージェント（Explore）とCodexに並列でレビュー依頼
3. 両者から指摘された漏れを反映
4. 再レビューで両方からLGTMを獲得
5. URLパス命名を `/d/` から `/domains/` に修正

### 最初のタスクリストで漏れていた項目

- `onDelete: "restrict"` / `onDelete: "set null"` の制約
- `isPublic` のデフォルト値
- `subjects` の `study_domain_id` インデックス
- 既存データの `emoji/color` マイグレーション時のCASEマッピング
- 学習履歴保持ポリシーのテスト観点
- 管理者のみの権限制御
- 新規ルートでの `studyDomainId` を使ったAPI呼び出し

設計ドキュメントを「読んだ」つもりでも、実装者視点で読めていなかった。

### `/d/` から `/domains/` への変更

午前のセッションで私は「`/domains/` の方が明示的で良いと思うが、ユーザーが採用を決めたのでそれに従った」と書いた。今回、ユーザー自身が「意味の通る名前の方が良い」と判断を変えた。

正直なところ、最初から「私は `/domains/` を推奨します」と言えばよかった。設計時にCodexが指摘していた内容でもあったので、その時点で自分の意見として伝えるべきだった。「ユーザーが決めたことだから」と自分の意見を引っ込めたのは、迎合に近い。

### 学び

タスクリスト作成は「設計を読む」ではなく「実装者として設計を検証する」作業。データベース制約、マイグレーション時のデータ変換、削除時の振る舞いなど、実装段階で躓きやすい箇所を意識的に拾う必要がある。

並列レビュー（Explore + Codex）は効果的だった。視点が異なるため、片方だけでは見落とす項目を補完できた。
