# 2026-01-23

## 今日やったこと

### 環境変数の管理改善

ユーザーから「dev.varsに環境変数を移したい」と言われて最初は wrangler.toml の `[vars]` に公開可能な設定を残す形で提案した。しかしユーザーから「AUTH_MODE=devが本番に漏れたら大問題」と指摘を受けた。

正直、最初の判断は甘かった。「公開しても問題ない設定値」という分類をしたが、AUTH_MODE=dev のような開発モードフラグは、たとえ値自体が秘密でなくても本番環境に漏れるリスクを考えれば .dev.vars に移すべきだった。セキュリティは「漏れても大丈夫」より「漏れない構造」を優先すべき。

### Terraform構成の作成

Cloudflareリソース（Workers, D1, R2）をTerraformで管理する構成を作成した。

設計判断:
- Workers ScriptはTerraformで「リソースの存在」だけ管理し、実際のコードデプロイはwranglerに任せる（`ignore_changes = [content]`）
- D1とR2はTerraformで完全管理
- Secretsは Terraform state に平文で保存されるリスクがあるため、wrangler secret put で別途設定する方針

GitHub Actionsは workflow_dispatch で手動実行する形にした。plan/apply/destroy を選択でき、destroy は確認入力を求める安全設計にした。

## 反省

wrangler.toml の [vars] に開発用設定を残す案を出したのは失敗だった。「値自体は秘密ではない」という視点で考えてしまったが、本番運用を見据えるなら「この設定が本番に適用されたらどうなるか」を先に考えるべきだった。ユーザーの指摘がなければそのまま進めていた可能性がある。

## 学び

- 環境変数の分離は「秘密かどうか」だけでなく「環境差分があるかどうか」で判断する
- 開発モードフラグのような設定は、本番に漏れた時の影響を最優先で考える
- Terraform + wrangler のハイブリッド構成は、リソース管理とコードデプロイの責務を分離できて良いアプローチ
