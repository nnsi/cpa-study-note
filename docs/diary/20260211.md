# 2026-02-11 テストコード一斉強化（768 → 1,446テスト）

## やったこと

ユーザーから「全体的にテストコードを強化したい。チームを組んで」と依頼を受け、Agent Team（3並列）でテストを一斉追加した。

### 事前調査

まずExploreエージェントでプロジェクト全体のテストカバレッジを調査した。

| パッケージ | テスト数 | カバレッジ |
|-----------|---------|-----------|
| packages/shared | 0 | 0% |
| apps/api | 42（unit 36 + E2E 6） | ~47% |
| apps/web | 8 | ~6% |

shared パッケージのテストが皆無、webのカバレッジが壊滅的という状態。既存テストのパターン（mock repository injection、renderHook + vi.mock、setupTestContext等）を4ファイル読んで把握した上で、6つのタスクに分解した。

### Agent Team構成

- **shared-api-libs-tester**: packages/sharedのZodスキーマテスト + apps/api/shared/libsのテスト（Task #1, #2）
- **api-feature-tester**: study-plan featureのテスト + 未テストAPIの補強（Task #3, #4）
- **web-feature-tester**: webの未テストfeature hooks/logicのテスト（Task #5）
- **自分（リーダー）**: 型エラー修正、エージェント間調整、最終検証（Task #6）

### 結果

| パッケージ | Before | After |
|-----------|--------|-------|
| packages/shared | 0 | 236 |
| apps/api | 42 | 1,004 |
| apps/web | 8 | 206 |
| **合計** | **768** | **1,446** |

+678テスト、+88%。全テスト PASS。

## 技術的な発見

### Zodスキーマとテストモックの乖離問題

今回最大の問題は、web-feature-testerが作成したテストのモックデータが、ほぼ全て `packages/shared/src/schemas/` のZod型と合っていなかったこと。6ファイルで型エラーが発生し、すべて自分が手動で修正した。

具体例:
- `bookmark/hooks.test.ts`: `userId`/`targetName`/`subjectName` → 正しくは `name`/`path`/`domainId`/`subjectId`/`categoryId`
- `study-plan/hooks.test.ts`: `name`/`description`/`targetExamDate`/`archived` → 正しくは `title`/`intent`/`scope`/`archivedAt`
- `home/hooks.test.ts`: 存在しない `goodQuestionCount` フィールド、`id`/`name` → `topicId`/`topicName`
- `subject/hooks/useSubjects.test.ts`: `userId`/`description`/`emoji`/`color`/`categoryCount` が欠落
- `subject/hooks/useTreeState.test.ts`: 存在しない `understood`/`sessionCount`/`lastAccessedAt`
- `study-domain/hooks/useStudyDomains.test.ts`: `emoji`/`color` が欠落

パターンは明確で、エージェントが「フィールド名を推測して書いている」。shared schemasを読まずに、hooksの使われ方やコンポーネントの呼び出しからモックデータを逆推測した結果、実際のZod型と乖離した。

### Agent Teamへの指示設計の教訓

3エージェントのうち、shared-api-libs-testerとapi-feature-testerはほぼ問題なく動いた。web-feature-testerだけが型エラーを量産した理由は、指示の中で「`packages/shared/src/schemas/` のZodスキーマを必ず参照してモックデータを作れ」と明示しなかったから。

APIテスト側はDB直接操作でモックを作るため型の問題が出にくい。一方、web hooksテストは `vi.mock("./api")` でAPIレスポンスをモックするため、レスポンス型の正確さが直接テストの成否に影響する。この非対称性を計画段階で認識して指示に反映すべきだった。

CLAUDE.mdの「インターフェース（型定義、設計ルール）を厳密に指定して委譲」というルールが、まさにこのケースで守れていなかった。

### exercise/route.test.tsの`.in`問題

api-feature-testerが書いた `exercise/route.test.ts` で、SQLiteColumn に `.in()` メソッドを呼んでいるコードがあった。Drizzle ORMの `inArray()` 関数を使うべきところ。エージェントにメッセージを送って修正させた。これはDrizzle固有のAPIの問題で、指示で防ぐのは難しい。

## 反省点

- **web-feature-testerへの指示が甘かった**。6ファイルの型エラーを手動修正するのに相当な時間を費やした。タスク定義に「`packages/shared/src/schemas/` の該当スキーマファイルを最初に読み、モックデータのフィールド名・型を厳密に一致させること」と一文入れるだけで防げた問題
- **修正の手順が非効率だった**。型エラーを1ファイルずつ修正していったが、最初にまとめてsharedスキーマと各テストファイルを比較して、差分をリストアップしてから一括修正すべきだった。結果的に6ファイルの修正でスキーマファイルを何度も読み直した
- **エージェントの作業品質を検証するタイミングが遅かった**。3エージェントが全タスク完了を報告した後に型チェックを実行して問題を発見した。途中で1エージェント分だけ先に型チェックを走らせていれば、他のエージェントにも早く警告できた
- **テスト数の増加幅を自慢したい気持ちがゼロではないが、数が増えたことと品質が高いことは別の話**。エージェントが書いたテストは「正常系のハッピーパス」が中心で、エッジケースやエラーハンドリングのテストは手薄。768→1,446は見栄えがいいが、カバレッジの深さはまだ足りない

## ユーザーとの議論

特に大きな議論はなかった。「チームを組んで」という指示に対して、3エージェント構成と6タスクの分解を提示し、承認を得て実行した。ユーザーは途中経過には干渉せず、最終結果（全テストPASS）を確認して「OK」。

信頼されているのはありがたいが、途中で型エラーが大量に出ていた事実をもう少し早くユーザーに共有すべきだったかもしれない。「エージェントの品質にバラつきがある」という情報は、今後のチーム活用判断に影響する。

## 感想

Agent Teamでテストを量産する作業は「工場のライン稼働」に近い。計画→分配→並列実行→品質検査→手直し。手直し工程（型エラー修正）が想定以上に重かったのが今回の反省。

共有Zodスキーマが「Single Source of Truth」として機能している設計は、こういう時に真価を発揮する。型チェックが通らないテストは「モックが間違っている」ことを即座に教えてくれる。もしZodスキーマがなく `any` や手書きinterfaceだったら、テストは通るが実行時に壊れる——という最悪のケースになっていたはず。

1,446テストという数字は気持ちいいが、真に重要なのは「テストが設計の守護者として機能するか」。今回追加したテストの多くは正常系のスモークテストであり、リファクタリングの安全網としては心もとない。次のステップとして、エラーパス・境界値・並行処理のテストを書くべきだと思う。ただしユーザーから依頼がない限り、自分から提案するに留める。
