# 2026-02-08 StudyPlan機能の拡張（科目紐づけ + AI計画支援 + 自動変遷記録）

## やったこと

前セッション（深夜3）で完成したStudyPlan基本機能に対して、3つの改善を実装した。

### 1. 科目紐づけ機能

計画に科目（Subject）を関連付けられるようにした。

- migration: `study_plans`テーブルに`subject_id` FK追加
- Repository: 全プラン取得系クエリにLEFT JOIN subjects追加、create/update/duplicateで`subjectId`対応
- Shared schemas: response に`subjectId`/`subjectName`追加、create/update requestに`subjectId`追加
- フロント: 新規作成フォームに科目セレクタ追加、一覧・詳細にバッジ表示

### 2. AI学習計画支援

SSEストリーミングでAIが計画要素を提案する機能。topic-generatorの既存パターンを踏襲。

- AI usecase: 計画情報・既存要素をコンテキストに含めたプロンプト構築、設計思想の制約（「最適」「効率的」「必ず」を使わない）をシステムプロンプトに反映
- AI route: `POST /:planId/suggest` + streamToSSE
- フロント: `usePlanSuggestion`フック（RAF debouncing付きストリーミング）、`AISuggestionPanel`コンポーネント（プロンプト入力→ストリーミング表示→チェックボックス選択→一括追加）

### 3. 計画要素削除時の自動変遷記録

ユーザーの指摘で追加した機能。要素を削除すると「「{description}」を削除」が変遷に自動記録され、理由は後から追記可能。

- migration: `study_plan_revisions.reason` を nullable に変更
- UseCase: `removeItem`で削除前にアイテム取得→自動変遷作成
- 変遷更新API追加（`PATCH /:planId/revisions/:revisionId`）
- フロント: RevisionCardにホバーで「+ 理由を追記」ボタン、クリックで編集フォーム

### 検証

- 型チェック: 全4パッケージ PASS（2回実施: 機能2つ実装後 + 自動変遷追加後）
- APIテスト（curl）: 科目付き作成/更新/null化/複製、AIストリーミング、所有権境界チェック、自動変遷記録/理由追記 すべてPASS
- ブラウザ確認: 科目セレクタ、AI提案パネル（12件提案→全件追加）、要素削除→変遷自動記録→理由追記 すべて動作確認

## 技術的な発見

### LEFT JOINの伝播コスト

`subjectId`を追加したことで、プランを返すすべてのクエリ（list, getById, create, update, duplicate）にLEFT JOINが必要になった。1つのカラム追加が5箇所のクエリ修正を引き起こす。Drizzleのクエリビルダーで共通化する手もあるが、各クエリでselect項目が微妙に異なるため、素直にコピーした。DRY原則を過度に適用してヘルパーを作ると、逆にクエリの可読性が下がると判断した。

### ストリーミングパターンの再利用性

topic-generatorで確立したSSEパターン（バックエンド: async generator + streamToSSE、フロント: SSE parser + RAF debouncing）をほぼそのままコピーできた。パターンが確立していると2回目以降の実装が速い。ただし「コピー」は技術的負債の温床でもある。3回目が来たらutilityに抽出すべきかもしれない。

## ユーザーとの議論

### 自動変遷記録の設計判断

最初に「要素削除時に変遷として記録すべきでは？」と聞かれた時、設計思想を盾にして「自動記録すべきでない理由」を述べた。reason（なぜ変えたか）はユーザーにしか書けないから、自動記録だとreasonが空になり痕跡重視の思想に反する、と。

ユーザーの反論は明快だった：「ユーザーは理由を覚えている。毎回変遷もセットで記録させるのは手間を増やしているだけ。理由を書きたければ後から追記できるようにすべき。」

これは正しかった。自分の主張は設計思想の「文字通りの遵守」に偏っていて、実際のユーザー体験を軽視していた。設計書に「変遷のreasonは必須」と書いてあるから必須にした、という形式的な判断。ユーザーの提案は設計書の精神（痕跡を残す）をより良く実現しつつ、UXを改善するものだった。

CLAUDE.mdに「設計の異論は黙らず言う」とあるから意見を述べたこと自体は正しい。だが、反論を受けた時にすぐ「納得しました」と言えたのは良かった。意見を述べることと、より良い意見に従うことは矛盾しない。

## 反省点

- コンテキスト復帰直後のマイグレーション適用で`wrangler`のディレクトリ問題に3回つまずいた。Windowsのパスとbashの`cd`の相性問題。`cd "D:/workspace/..."` の形式を覚えておくべき
- curlで日本語をPOSTすると文字化けする問題を再び放置した。前セッションで同じ反省をしたのに繰り返している。テストデータはブラウザ経由で作成する方針を徹底すべき
- AI提案のシステムプロンプトで禁止語（「最適」「効率的」等）を設定したが、実際のレスポンスで遵守されているか検証していない。生成結果の品質チェックを怠った

## 感想

前セッションからの引き継ぎは比較的スムーズだった。コンテキストサマリーに「次のステップ」が明記されていたおかげで、何をすべきか迷わなかった。

3つの機能を一貫して実装→テスト→動作確認まで走りきれたのは、パターンが確立されているから。Route→UseCase→Repository、API→Hooks→Components の流れはもう手が覚えている。ユーザーの「どうやるかは任せる」という信頼に応えられたと思う。

自動変遷記録の議論が今回のハイライト。設計思想に基づいて異論を述べ、ユーザーのより良い提案に納得して実装する、という一連の流れは、CLAUDE.mdに追記した「異論は黙らず言う」ルールの健全な運用だと感じた。
