# 2026-02-04

## 作業内容

fb2-refactoring-tasks.md の全タスクを完了した。大規模なリファクタリングだった。

### 実装した内容

1. **Learning feature新規作成**: Subject から進捗管理機能を分離。touch, progress, check-history のエンドポイントを実装。
2. **View feature新規作成**: 読み取り専用のビュー集約レイヤー。TopicView, SubjectDashboard, ReviewList など。
3. **Subject featureのクリーンアップ**: Curriculum（構造管理）のみを残し、Learning/View に移行済みのコードを削除。
4. **Bookmark機能のセキュリティ修正**: targetExists/getBookmarkDetails に userId/deletedAt 条件を追加。IDOR脆弱性を修正。
5. **エラーレスポンス形式の統一**: `{ error: { code, message, details? } }` 形式に統一。
6. **フロントエンドのAPI呼び出し先変更**: Subject → Learning/View への移行。

### コードレビュー

サブエージェント（Explore）と Codex CLI に並列でレビューを依頼した。

- **Codex の誤検知**: PowerShell 経由で日本語コメントを読むと文字化けし、「構文エラー」と誤検出された。CLAUDE.md に記載のある既知問題。型チェックとテストが通っていればそちらを信頼する方針で対応。
- **サブエージェントの指摘**: subject/repository.ts に不要な progress 系メソッドが残っていた。これは見落としだった。指摘に従って削除した。

最終的に両方から LGTM を取得。

### ブラウザテスト

Chrome MCP でリファクタ対象の機能を一通り確認した。全機能正常動作。

## 反省点

- **不要コードの削除漏れ**: Phase 4 で「削除すべきメソッド」をリストアップしていたが、`findFilteredTopics`/`searchTopics` は削除したのに `findProgress`/`upsertProgress`/`createCheckHistory`/`findCheckHistoryByTopic` を削除し忘れた。タスクリストの項目を一つずつ照合すべきだった。
- **サブエージェントの活用**: ユーザーから「自分で作業せずサブエージェントに任せて」と指示があった。大規模リファクタリングでは並列実行が効果的だが、最終的な整合性チェックは自分で行う必要がある。サブエージェントの結果を鵜呑みにせず、レビューで拾えたのは良かった。

## 学び

- **コードレビューの二重チェック**: 異なるツール（サブエージェント vs Codex）は異なる観点で指摘する。Codex はエンコーディング問題に弱いが、サブエージェントは実装の一貫性を見る。両方使うことで網羅性が上がる。
- **タスクリストの粒度**: fb2-refactoring-tasks.md は詳細なチェックリストになっていたが、「削除すべきメソッド」のリストが複数行にまたがっていて見落としやすかった。一行一項目にするか、実行時に逐一確認する仕組みが欲しい。

## 所感

大きなリファクタリングを一気にやるのは達成感がある。Learning/View/Subject の責務分離がきれいになった。ただ、これだけの変更量だと「本当に全部正しいか」という不安は残る。テストと型チェックが通り、ブラウザでも動作確認できたので、おそらく大丈夫だろう。

ユーザーの指示は明確で作業しやすかった。「サブエージェントに任せて」という方針は、コンテキスト節約と並列化の観点で合理的。ただ、最終責任は自分にあるので、レビューフェーズでの確認は手を抜けない。
