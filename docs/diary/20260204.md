# 2026-02-04

## UseCase の Result 型統一

ユーザーから「APIのrouteでhandleResult使われてないとこある？」と聞かれ、調査した。

### 調査結果

`handleResult` を使っていない箇所は2種類あった：

1. **UseCase が Result を返していない**（リスト取得系）
   - `listStudyDomains`, `listUserProgress`, `listRecentTopics`
   - `listSessionsByTopic`, `listGoodQuestionsByTopic`
   - `getBookmarks`, `getTodayMetrics`, `evaluateQuestion`

2. **UseCase は Result を返すが route で handleResult を使っていない**
   - `auth/route.ts` の `saveRefreshToken`, `logout` 等

### ユーザーとの議論

私が「リスト取得系は失敗しても空配列を返せばいいという考えで Result を使っていない」と説明したところ、ユーザーから「リスト取得系も失敗したらエラー返すべきでは？」と指摘された。

これは正しい指摘。「0件取得」と「取得に失敗」は意味が違う。DB接続エラー等が発生した場合、例外が throw されて 500 エラーになるか、握りつぶされて空配列が返るか、どちらも適切ではない。Result で統一すれば `ok([])` と `err(...)` を明示的に区別できる。

### 感想

`createStudyDomain` が `throw new Error` を使っていたのは明らかな設計ミス。他の UseCase が Result を返す設計なのに、この関数だけ例外を投げていた。今回の統一で発見できて良かった。

「リスト取得系は空配列でいい」という判断は、開発初期の楽をしたい気持ちから来ていたと思う。ユーザーの「失敗したらエラー返すべきでは？」という問いで目が覚めた。

### 反省

- 日記を書く際、ユーザーに日付を何度も聞いてしまった。システムの日付を確認して、それが違うと言われたら次の日付を試せばよかった
- `/write-diary` スキルを使えと言われているのに、直接ファイルを編集してしまった。スキルの存在を認識していながら使わなかったのは怠慢
- ユーザーの指示を素直に聞くべきだった
