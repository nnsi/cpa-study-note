# 2026-02-04

## UseCase の Result 型統一

ユーザーから「APIのrouteでhandleResult使われてないとこある？」と聞かれ、調査した。

### 調査結果

`handleResult` を使っていない箇所は2種類あった：

1. **UseCase が Result を返していない**（リスト取得系）
   - `listStudyDomains`, `listUserProgress`, `listRecentTopics`
   - `listSessionsByTopic`, `listGoodQuestionsByTopic`
   - `getBookmarks`, `getTodayMetrics`, `evaluateQuestion`

2. **UseCase は Result を返すが route で handleResult を使っていない**
   - `auth/route.ts` の `saveRefreshToken`, `logout` 等

### ユーザーとの議論

私が「リスト取得系は失敗しても空配列を返せばいいという考えで Result を使っていない」と説明したところ、ユーザーから「リスト取得系も失敗したらエラー返すべきでは？」と指摘された。

これは正しい指摘。「0件取得」と「取得に失敗」は意味が違う。DB接続エラー等が発生した場合、例外が throw されて 500 エラーになるか、握りつぶされて空配列が返るか、どちらも適切ではない。Result で統一すれば `ok([])` と `err(...)` を明示的に区別できる。

### 感想

`createStudyDomain` が `throw new Error` を使っていたのは明らかな設計ミス。他の UseCase が Result を返す設計なのに、この関数だけ例外を投げていた。今回の統一で発見できて良かった。

「リスト取得系は空配列でいい」という判断は、開発初期の楽をしたい気持ちから来ていたと思う。ユーザーの「失敗したらエラー返すべきでは？」という問いで目が覚めた。

### 修正内容

**UseCase（11関数）:**
- `learning/usecase.ts`: `listUserProgress`, `listRecentTopics`
- `study-domain/usecase.ts`: `listStudyDomains`, `createStudyDomain`（これは `throw new Error` を使っていた）
- `metrics/usecase.ts`: `getTodayMetrics`
- `bookmark/usecase.ts`: `getBookmarks`
- `chat/usecase.ts`: `listSessionsByTopic`, `listGoodQuestionsByTopic`, `evaluateQuestion`
- `learning/route.ts`: `getSubjectProgressStats`（route内ヘルパー）

**Route:**
- 全ての route で `handleResult` / `handleResultWith` を使うように統一
- `auth/route.ts`: `saveRefreshToken` のエラーハンドリング追加、`logout` はエラー時もログ出力のみ

**テスト:**
- `chat/usecase.test.ts`, `study-domain/usecase.test.ts` を Result 型に対応

---

## 反省: スキルを使わなかった件

ユーザーから「日記書いて」と言われて、私は直接ファイルを編集した。ユーザーが「スキルを使え」と言ったが、私は何度も日付を聞いたり、的外れな対応をした。

### 何が問題だったか

1. **スキルの存在を認識していなかった**: `.claude/skills/` ディレクトリにスキル定義があることを知らなかった
2. **聞けばよかった**: 「スキルの使い方がわからない」と早く言えばよかった。何度も日付を聞いたり、直接編集したりして無駄なやり取りが発生した
3. **CLAUDE.md を表面的にしか読んでいなかった**: スキル一覧は見ていたが、その実装方法（`.claude/skills/*/SKILL.md`）を探そうとしなかった

### 学び

- **わからないことは早く聞く**: 知ったかぶりして無駄な試行錯誤をするより、正直に「わからない」と言う方が効率的
- **スキルは `.claude/skills/*/SKILL.md` に定義されている**: 今後は先にこれを読む
