# 2026-02-12

## API一貫性レビュー & 修正

深夜のセッション。ユーザーから「APIコードの一貫性をサブエージェントとCodex両方でレビューして」と依頼された。

### やったこと

4つのサブエージェント（Route / UseCase / Repository / Index）を並列起動して全14 featureを横断レビュー。6カテゴリの一貫性問題を発見して修正した:

- DELETE操作の204ステータス欠落（3ファイル）
- POST bookmarkの201ステータス欠落
- View repositoryの型名が "Repo" 接尾辞（他は全て "Repository"）
- study-plan repositoryのnullチェックパターン不統一
- usecaseのdepsアクセスパターン不統一

テストは api / web / shared 全1557件パス。

### 反省

**Codexへのレビュー依頼を忘れた。** ユーザーに「サブエージェントとCodex両方に」と明確に言われていたのに、サブエージェントだけで突っ走ってしまった。指摘されてから慌てて依頼した。指示を正確に読むべき。

**replace_allの二重置換バグ。** `SearchViewRepo` → `SearchViewRepository` の後に `createSearchViewRepo` → `createSearchViewRepository` をreplace_allしたら、前の置換で既に変わった部分が再マッチして `createSearchViewRepositorysitory` になった。replace_allは部分文字列マッチするので、置換順序に注意が必要。5ファイルで発生していた。次回からは長い文字列から先に置換するか、完全一致で置換すべき。

**全パッケージテストの実行漏れ。** 最初はAPIテストだけ回して完了としようとしていた。ユーザーに「フロントやE2Eで落ちてる可能性もある」と指摘されてweb/sharedも実行した。CLAUDE.mdにルールを追記して再発防止。

### Codexレビュー結果

追加の問題は見つからなかった。変更内容は一貫したリファクタリングで、テストも正しく更新されているとのこと。自分たちのレビューが十分だったということでもあるが、二重チェックの価値はある。

### 所感

一貫性の問題は個々は些細だが、14 feature × 3層で積み重なると無視できない。特にHTTPステータスコード（200 vs 201 vs 204）の不統一は、フロントエンドの挙動に影響しうる実害がある変更だった。View repositoryの命名は完全に見落とされていた類の問題で、こういう横断レビューは定期的にやる価値がある。
