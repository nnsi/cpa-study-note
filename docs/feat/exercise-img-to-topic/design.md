# 問題画像→論点チェック機能 設計

## 概要

解いた問題の画像をアップロードし、AIが対応する論点を提案、ユーザーが確認・決定して論点チェックを付ける機能。

### 思想との整合

| 原則 | 本機能での遵守 |
|------|----------------|
| 判断しない | AIは論点を「提案」するのみ。理解度は評価しない |
| 論点中心 | 問題画像は論点に紐づいて保存される |
| 痕跡を残す | 「この問題を解いた」事実が論点に残る |
| ユーザー主導 | 論点の確定・チェックはユーザーが行う |

---

## ユーザーフロー

```
[問題画像をアップロード]
       ↓
   OCRでテキスト化
       ↓
AIが論点を推測（1〜3件の候補）
       ↓
ユーザーが論点を確認
  - 提案を採用
  - 別の論点を選択
  - 新規論点を指定（将来）
       ↓
論点に問題画像が紐づく
       ↓
（任意）ユーザーが「理解した」→ 論点チェックON
```

---

## API設計

### 1. 画像アップロード + OCR + 論点推測

```
POST /api/exercises/analyze
Content-Type: multipart/form-data

Request:
  - image: File (問題画像)

Response:
{
  "exerciseId": "ex_abc123",
  "ocrText": "問1 A社はB社株式の30%を...",
  "suggestedTopics": [
    {
      "topicId": "topic_001",
      "topicName": "持分法",
      "subjectName": "財務会計論",
      "confidence": "high",
      "reason": "「30%」「持分法適用」というキーワードを検出"
    },
    {
      "topicId": "topic_002",
      "topicName": "関連会社の判定",
      "subjectName": "財務会計論",
      "confidence": "medium",
      "reason": "関連会社の範囲に関する問題の可能性"
    }
  ]
}
```

**設計意図**:
- `confidence` は high/medium/low の3段階（ユーザーの参考情報）
- `reason` はAIが推測した根拠（透明性確保）
- 候補は最大3件（選択肢過多を防ぐ）

---

### 2. 論点確定 + 保存

```
POST /api/exercises/:exerciseId/confirm
Content-Type: application/json

Request:
{
  "topicId": "topic_001",
  "markAsUnderstood": true  // 任意：同時にチェックを付ける
}

Response:
{
  "exerciseId": "ex_abc123",
  "topicId": "topic_001",
  "topicChecked": true,
  "createdAt": "2026-01-26T10:00:00Z"
}
```

**設計意図**:
- `markAsUnderstood` は任意（デフォルト false）
- 論点紐づけとチェックを分離可能（紐づけだけして後でチェックも可）

---

### 3. 論点に紐づく問題一覧

```
GET /api/topics/:topicId/exercises

Response:
{
  "exercises": [
    {
      "exerciseId": "ex_abc123",
      "imageUrl": "https://...",
      "ocrText": "問1 A社は...",
      "createdAt": "2026-01-26T10:00:00Z",
      "markedAsUnderstood": true
    }
  ]
}
```

---

## データモデル

```
Exercise
  - id: string
  - userId: string
  - imageKey: string (R2 key)
  - ocrText: string
  - topicId: string | null (確定前はnull)
  - suggestedTopicIds: string[] (AI提案の履歴)
  - markedAsUnderstood: boolean
  - createdAt: timestamp
  - confirmedAt: timestamp | null
```

---

## UI設計

### 画面1: 画像アップロード

```
┌─────────────────────────────────────┐
│  問題画像をアップロード              │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │     📷 タップして撮影       │   │
│  │     または画像を選択        │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  [アップロード]                     │
└─────────────────────────────────────┘
```

---

### 画面2: 論点提案（アップロード後）

```
┌─────────────────────────────────────┐
│  ← 戻る                             │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  [問題画像サムネイル]       │   │
│  └─────────────────────────────┘   │
│                                     │
│  OCR結果:                           │
│  「問1 A社はB社株式の30%を...」    │
│                                     │
│  ─────────────────────────────────  │
│  この問題の論点は？                 │
│  ─────────────────────────────────  │
│                                     │
│  ◉ 持分法（財務会計論）       推奨  │
│    「30%」「持分法適用」を検出      │
│                                     │
│  ○ 関連会社の判定（財務会計論）    │
│    関連会社の範囲に関する可能性     │
│                                     │
│  ○ 別の論点を選ぶ...               │
│                                     │
│  ─────────────────────────────────  │
│  ☑ この論点は理解した              │
│  ─────────────────────────────────  │
│                                     │
│  [確定する]                         │
└─────────────────────────────────────┘
```

**UIポイント**:
- AIの提案理由を表示（透明性）
- 「推奨」は最も confidence が高いもの
- 「別の論点を選ぶ」で全論点から検索可能
- 「この論点は理解した」チェックは任意（デフォルトOFF）

---

### 画面3: 完了

```
┌─────────────────────────────────────┐
│                                     │
│           ✓ 保存しました            │
│                                     │
│  「持分法」に問題を追加しました     │
│                                     │
│  [論点を見る]  [続けて追加]         │
│                                     │
└─────────────────────────────────────┘
```

---

### 論点詳細画面への統合

論点詳細画面に「解いた問題」タブを追加:

```
┌─────────────────────────────────────┐
│  持分法                      ☑     │
│  財務会計論                         │
│                                     │
│  [ノート] [チャット] [問題]        │
│                        ^^^^^^       │
│  ─────────────────────────────────  │
│                                     │
│  解いた問題 (3件)                   │
│                                     │
│  ┌───┐ 2026/01/26                  │
│  │ 📷 │ 問1 A社はB社株式の30%を... │
│  └───┘ ✓ 理解済み                  │
│                                     │
│  ┌───┐ 2026/01/20                  │
│  │ 📷 │ 問3 持分法による投資...    │
│  └───┘                              │
│                                     │
│  [+ 問題を追加]                     │
└─────────────────────────────────────┘
```

---

## 論点推測プロンプト（参考）

```
あなたは公認会計士試験の論点分類アシスタントです。

以下の問題文を読み、最も関連する論点を1〜3件推測してください。

## 問題文
{ocrText}

## 論点リスト
{topicList}

## 出力形式
各論点について以下を出力:
- topicId
- confidence: high / medium / low
- reason: 推測の根拠（30字以内）

推測に自信がない場合は正直に low と出力してください。
```

---

## 実装順序

1. **Phase 1: 基盤**
   - Exercise テーブル作成
   - 画像アップロード API（R2保存）
   - OCR API呼び出し

2. **Phase 2: 論点推測**
   - 論点推測プロンプト作成
   - /analyze API実装
   - 提案UI実装

3. **Phase 3: 確定・保存**
   - /confirm API実装
   - 論点詳細への「問題」タブ追加
   - TopicCheckとの連携

---

## 将来拡張

- 問題から直接チャットを開始（「この問題について質問する」）
- 同じ論点の問題を並べて復習
- 問題の難易度を自己評価で記録
