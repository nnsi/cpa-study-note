# クイックチャット（音声認識 + 論点サジェスト）設計

## 概要

ホーム画面からテキスト入力または音声入力で質問し、AIが既存論点から候補を提案。ユーザーが論点を選択するとチャット画面に遷移し、質問が初回メッセージとして自動送信される。

**解決する課題**: 現状のチャット開始導線が長い（ホーム → 論点マップ → 科目 → カテゴリ → 論点 → チャット開始 = 最低5タップ）

**この機能での導線**: ホーム → 質問入力 → 論点選択 → チャット開始（自動送信）= 2〜3タップ + 入力

### 思想との整合

| 原則 | 本機能での遵守 |
|------|----------------|
| 判断しない | AIは論点を「提案」するのみ。ユーザーが選択して確定する |
| 論点中心 | 質問は必ず論点に紐づいてチャットが開始される |
| 痕跡を残す | 通常のチャットセッションとして論点に記録される |
| ユーザー主導 | 論点の最終選択・新規作成の判断はユーザーが行う |
| 主教材と併用 | AIチャット開始の導線短縮であり、学習方法の変更ではない |

---

## ユーザーフロー

```
[ホーム画面: ドメイン選択済み]
         ↓
  テキスト入力 or 音声入力（Web Speech API）
         ↓
  質問テキスト確定（生テキストのまま）
         ↓
  AI が全科目の論点名を参照し候補を返す
    ├─ 既存論点にマッチ → 候補 1〜3件を表示
    └─ マッチなし → 新規論点の作成を提案（科目+カテゴリ+論点名をAIが提案）
         ↓
  ユーザーが論点を選択（既存 or 新規作成を確認）
         ↓
  チャット画面に遷移
    → 質問テキストが初回メッセージとして自動入力・自動送信
    → AIレスポンスがストリーミングで返る
```

---

## API設計

### 論点サジェストエンドポイント

`POST /api/quick-chat/suggest`

```json
// Request
{
  "domainId": "domain_001",
  "question": "減損損失の計算でのれんの配分がよく分からない"
}

// Response
{
  "suggestions": [
    {
      "type": "existing",
      "topicId": "topic_042",
      "topicName": "のれんの減損",
      "categoryName": "減損会計",
      "subjectName": "財務会計論",
      "confidence": "high",
      "reason": "「のれん」「減損」のキーワードが一致"
    },
    {
      "type": "existing",
      "topicId": "topic_038",
      "topicName": "減損損失の認識と測定",
      "categoryName": "減損会計",
      "subjectName": "財務会計論",
      "confidence": "medium",
      "reason": "減損損失の計算に関連"
    },
    {
      "type": "new",
      "topicId": null,
      "topicName": "のれんの配分と減損",
      "categoryName": "減損会計",
      "categoryId": "cat_012",
      "subjectId": "sub_003",
      "subjectName": "財務会計論",
      "confidence": "low",
      "reason": "既存論点では対象範囲が異なる可能性"
    }
  ]
}
```

**設計意図**:
- `type: "existing" | "new"` で既存マッチと新規提案を区別
- 新規提案の場合、既存のカテゴリに配置する候補を返す（categoryIdあり）
- カテゴリも新規の場合は `categoryId: null` で返し、フロントで作成フローに繋げる
- 候補は最大3件。既存マッチがあればそれを優先、なければ新規提案を含める
- `confidence` と `reason` で透明性を確保

### 新規論点作成

既存の `PUT /api/subjects/:id/tree` を利用。クイックチャット専用の作成APIは設けない。

### チャット開始

既存の `POST /api/chat/topics/:topicId/messages/stream` を利用。セッション作成+初回メッセージ送信を1リクエストで行える既存エンドポイント。

---

## AIプロンプト設計

```
あなたは学習論点の分類アシスタントです。

ユーザーの質問に最も関連する論点を、既存の論点リストから1〜3件選んでください。
適切な既存論点がない場合は、新規論点の作成を提案してください。

## ユーザーの質問
{question}

## 既存の論点リスト
{topicList}
（形式: subjectName / categoryName / topicName [topicId]）

## 出力形式（JSON）
{
  "suggestions": [
    {
      "type": "existing" | "new",
      "topicId": "既存の場合はID、新規はnull",
      "topicName": "論点名",
      "categoryName": "カテゴリ名",
      "categoryId": "既存カテゴリに配置する場合はID、新規カテゴリはnull",
      "subjectId": "科目ID",
      "subjectName": "科目名",
      "confidence": "high" | "medium" | "low",
      "reason": "選定理由（30字以内）"
    }
  ]
}

## ルール
- 既存論点で十分マッチするなら新規提案は不要
- confidence が low の既存論点より、新規提案の方が適切ならそちらを優先
- 科目・カテゴリが判別できない質問には confidence: "low" を付与
- 出力はJSON のみ。説明文は不要
```

---

## フロントエンド設計

### ホーム画面の変更

ダッシュボードの最上部（挨拶の直下）にクイックチャット入力エリアを配置。

```
┌─────────────────────────────────────┐
│  こんにちは、○○さん                │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 質問を入力して学習を始める... 🎤│   │
│  └─────────────────────────────┘   │
│                                     │
│  [続きから学習]                     │
│  ...                                │
└─────────────────────────────────────┘
```

- テキスト入力欄 + マイクボタン（右端）
- マイクボタン押下 → Web Speech API で音声認識開始
- 音声認識中はテキストがリアルタイムで入力欄に表示される
- Enter or 送信ボタンで論点サジェストAPIを呼び出し

### ドメイン選択

- ユーザーが複数ドメインを持つ場合、入力欄の上部にドメイン選択UIを表示
- 単一ドメインの場合は自動選択（UIに表示しない）

### 論点サジェスト結果の表示

入力欄の下にインラインで候補リストを展開。

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐   │
│  │ のれんの配分が分からない  🎤│   │
│  └─────────────────────────────┘   │
│                                     │
│  関連する論点:                      │
│                                     │
│  ◉ のれんの減損              推奨  │
│    財務会計論 › 減損会計            │
│                                     │
│  ○ 減損損失の認識と測定            │
│    財務会計論 › 減損会計            │
│                                     │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄  │
│  ＋ 新しい論点を作成               │
│    「のれんの配分と減損」           │
│    財務会計論 › 減損会計            │
│                                     │
└─────────────────────────────────────┘
```

- 既存論点はラジオボタンで選択
- 新規論点は区切り線の下に表示
- 選択後、チャット画面へ遷移

### チャット画面遷移後の体験

1. チャット画面に遷移
2. ユーザーの質問テキストがメッセージとして表示される
3. 自動で `POST /api/chat/topics/:topicId/messages/stream` を呼び出し
4. AIレスポンスがストリーミングで表示される

**将来的なUX改善案**: 音声認識テキストをSSE風にリアルタイム表示し、認識完了→論点選択→チャット画面遷移→AIレスポンスのストリーミングが途切れなく繋がる体験。

---

## 音声認識

### Web Speech API

```typescript
const recognition = new webkitSpeechRecognition()
recognition.lang = "ja-JP"
recognition.interimResults = true  // リアルタイム表示用
recognition.continuous = false     // 1発話で終了

recognition.onresult = (event) => {
  const transcript = event.results[0][0].transcript
  // 入力欄に反映
}
```

- `interimResults: true` で認識途中のテキストもリアルタイムに入力欄へ反映
- 認識完了後、テキストは生テキストのまま（音声補正なし）でサジェストAPIへ送信
- 非対応ブラウザではマイクボタンを非表示にし、テキスト入力のみにフォールバック

### ブラウザ対応

| ブラウザ | Web Speech API | 対応方針 |
|---------|---------------|---------|
| Chrome / Edge | 対応 | フル機能 |
| Safari | 部分対応 | 動作確認して対応 |
| Firefox | 非対応 | テキスト入力のみ |

---

## AI設定

`config.ts` に `quickChatSuggest` を追加。

```typescript
quickChatSuggest: {
  model: "google/gemini-2.5-flash",
  temperature: 0,      // 分類タスクなので決定的に
  maxTokens: 500,      // JSON出力のみなので少なめ
}
```

---

## データモデル

新規テーブルは不要。既存のテーブルのみで実現可能:
- チャットセッション: `chatSessions` テーブル（既存）
- 論点: `topics` テーブル（既存）
- 新規論点作成: `PUT /api/subjects/:id/tree`（既存）

---

## 実装順序

### Phase 1: バックエンド — 論点サジェストAPI
- `POST /api/quick-chat/suggest` エンドポイント実装
- AIプロンプト作成・調整
- ドメイン内の全論点取得ロジック

### Phase 2: フロントエンド — クイックチャットUI
- ホーム画面に入力エリア追加
- 論点サジェスト結果の表示UI
- 論点選択 → チャット画面遷移 → 自動送信フロー
- ドメイン選択UI（複数ドメイン対応）

### Phase 3: 音声認識
- Web Speech API統合
- マイクボタンUI
- リアルタイムテキスト表示
- ブラウザ対応判定・フォールバック

### Phase 4: 新規論点作成フロー
- サジェスト結果から新規論点作成の確認UI
- 既存の tree API を使った論点作成
- 作成後、そのままチャット開始

---

## 設計ノート

### 将来検討事項
- **`topic-generator/suggest` との統合**: 現在の論点生成AIと、本機能の論点サジェストは入力（質問 vs プロンプト）と出力（既存マッチング vs 新規生成）が異なるが、「科目・論点の新規作成もAIが提案する」という点では共通する。将来的に統合し、suggestエンドポイント自体が科目・カテゴリ・論点の新規作成まで一貫して提案できる形にすることを検討
- **音声補正の組み込み**: 現状は生テキストでサジェストAPIに送信するが、マッチング精度が悪い場合は既存の `correct-speech` APIを間に挟むことを検討
- **レイテンシ最適化**: 論点数が多い場合（数百件）、全論点名をプロンプトに含めるとトークン数が増大する。将来的にはembeddingベースの事前フィルタリングを検討
