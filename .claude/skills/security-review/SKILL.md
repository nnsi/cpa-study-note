---
name: security-review
description: セキュリティレビューを複数の視点で実施する。使用場面: (1) 新機能実装後、(2) 認証・認可周りの変更後、(3) ユーザー入力を扱う処理の追加後、(4) リリース前。トリガー: "セキュリティレビュー", "セキュリティチェック", "/security-review"
---

# セキュリティレビュー

複数の視点でセキュリティレビューを実施する。単一の視点では見落としがあるため、以下の3つを**並行**で実行する。

## 実行手順

### 1. 3つのレビューを並行起動

以下のサブエージェントを**同時に**起動する:

```
# サブエージェント1: Exploreエージェント
「以下の観点でセキュリティレビューを実施:
- 認可漏れ（IDOR）: 他ユーザーのリソースにアクセスできないか
- 入力バリデーション: Zodスキーマにmax制限、enum制限があるか
- 環境変数: 本番に漏れてはいけない値が分離されているか
- エラー情報漏洩: スタックトレースやDB構造が露出しないか」

# サブエージェント2: Codex CLI
codex exec --full-auto --sandbox read-only --cd /path/to/project \
  "このプロジェクトのセキュリティ脆弱性を調査してください。
   特に認証・認可、入力検証、エラー処理に注目してください。"

# サブエージェント3: ペネトレーションテスト視点
「セキュリティ報告書の内容を知らせずに、攻撃者視点で以下を試行:
- プロンプトインジェクション（システムプロンプト開示要求）
- パストラバーサル（../を含むファイル名）
- 巨大ファイルアップロード
- 不正なMIMEタイプ
- 他ユーザーのリソースへの直接アクセス」
```

### 2. 結果の統合

3つのレビュー結果を統合し、重複を除去して以下の形式でまとめる:

| 重大度 | 問題 | 影響 | 対応案 |
|--------|------|------|--------|
| Critical | ... | ... | ... |
| High | ... | ... | ... |
| Medium | ... | ... | ... |
| Low | ... | ... | ... |

### 3. 対応の優先順位付け

- **Critical/High**: 即座に対応
- **Medium**: 今回のセッションで対応を検討
- **Low**: 記録して後日対応

---

## チェックリスト

### 認証・認可

- [ ] 全ての保護エンドポイントに認証ミドルウェアが適用されている
- [ ] リソースアクセス時にユーザーIDでフィルタしている
- [ ] JWTシークレットの強度検証がある
- [ ] リフレッシュトークンがHttpOnly Cookieに保存されている

### 入力バリデーション

- [ ] 文字列にmax制限がある
- [ ] ファイルサイズに制限がある
- [ ] MIMEタイプがホワイトリストで検証されている
- [ ] マジックバイト検証でファイル形式を確認している
- [ ] ファイル名がサニタイズされている（パストラバーサル防止）

### AIセキュリティ

- [ ] システムプロンプトの先頭にセキュリティ指示がある
- [ ] プロンプトインジェクションで役割変更されない
- [ ] システムプロンプトが開示されない

### インフラ

- [ ] CORS設定が本番では特定オリジンのみ許可
- [ ] セキュリティヘッダー（X-Frame-Options等）が設定されている
- [ ] 環境変数が本番/開発で適切に分離されている

---

## 出力

レビュー完了後、`docs/security-review.md` に結果を記録する。
