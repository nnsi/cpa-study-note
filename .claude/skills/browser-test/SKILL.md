---
name: browser-test
description: ブラウザでの動作確認を実施する。curlでは検出できない問題（CORS、Cookie、認証フロー）を発見する。使用場面: (1) API実装後、(2) 認証周りの変更後、(3) フロントエンド実装後。トリガー: "ブラウザで確認", "Chromeで確認", "/browser-test"
---

# ブラウザテスト

curlでは検出できない問題を発見するため、実際のブラウザで動作確認を行う。

## 重要: curlとブラウザの違い

| 観点 | curl | ブラウザ |
|------|------|----------|
| CORS | 影響なし | `Access-Control-Allow-Origin` が必要 |
| Cookie | 手動送信 | `credentials: 'include'` で自動送信 |
| `Headers`オブジェクト | 関係なし | スプレッド展開で空になる可能性 |
| Preflight | 発生しない | OPTIONS リクエストが先行 |

**curlで動いてもブラウザで動くとは限らない。必ず両方で確認すること。**

---

## 実行手順

### 1. 開発サーバー起動

```bash
# APIとWebを両方起動
pnpm dev
```

### 2. Chromeで動作確認

ユーザーに http://localhost:5173 を開いてもらい、以下を確認する。

**DevToolsの活用:**
- **Network**: リクエスト/レスポンス、ステータスコード、Cookie送信
- **Console**: CORSエラー、JavaScriptエラー
- **Application**: Cookie、LocalStorage の状態

**確認の依頼例:**
```
「Chromeで http://localhost:5173 を開いて、以下を確認してもらえますか:
1. [具体的な操作]
2. DevToolsのNetworkタブで [確認したいこと]
3. 結果を教えてください」
```

### 3. 確認すべきフロー

#### 認証フロー

- [ ] 開発ログインボタンが表示される
- [ ] ログイン後、アクセストークンが発行される
- [ ] リロード後、リフレッシュトークンで再認証される（401→200）
- [ ] ログアウト後、再度ログインが必要になる

#### CORS・Cookie

- [ ] API呼び出しが成功する（503でない）
- [ ] Cookieが正しく送信されている（DevToolsのNetworkタブで確認）
- [ ] Preflightリクエスト（OPTIONS）が正しく処理される

#### 基本操作

- [ ] 科目一覧 → カテゴリ一覧 → 論点一覧 → 論点詳細
- [ ] チャット送信 → ストリーミング表示
- [ ] 画像アップロード → OCR結果表示
- [ ] ノート作成 → 一覧に反映

---

## 現実的なデータでのテスト

小さなテストデータだけでなく、実際のユースケースを想定したテストを行う。

### ファイルサイズ

| テスト | サイズ | 期待結果 |
|--------|--------|----------|
| 小さい画像 | 100KB | 正常にアップロード |
| 大きい画像 | 5MB | 正常にアップロード |
| 制限超過 | 11MB | 413 File too large |

### 長文テキスト

| テスト | 文字数 | 期待結果 |
|--------|--------|----------|
| 短い質問 | 50文字 | 正常に送信 |
| 長い質問 | 5000文字 | 正常に送信 |
| 制限超過 | 15000文字 | 400 Bad Request |

---

## トラブルシューティング

### 503エラー

```
原因: CORS設定の問題
確認: DevToolsのConsoleでCORSエラーを確認
対策: APIのCORS設定で動的オリジン返却を確認
```

### Cookieが送信されない

```
原因: credentials設定の問題
確認: DevToolsのNetworkでRequest Headersを確認
対策: fetch/api-clientで `credentials: 'include'` を設定
```

### リロードで認証が切れる

```
原因: リフレッシュトークンが機能していない
確認: DevToolsのApplicationでCookieを確認
対策: /api/auth/refresh エンドポイントの動作を確認
```

---

## 出力

動作確認結果をチェックリスト形式で報告する。問題があった場合は原因と対策も記載。
