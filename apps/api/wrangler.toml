name = "cpa-study-api"
main = "src/index.ts"
compatibility_date = "2024-12-30"

[[d1_databases]]
binding = "DB"
database_name = "cpa-study-db"
database_id = "local"
migrations_dir = "../../packages/db/migrations"

[[r2_buckets]]
binding = "R2"
bucket_name = "cpa-study-images"

# Durable Objects (Rate Limiter)
[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["RateLimiterDO"]

# ===========================================
# Workers Analytics Engine (Log Collection)
# ===========================================
[[analytics_engine_datasets]]
binding = "LOGS"
dataset = "api_logs"

# ============================================
# ステージング環境設定 (masterブランチ → stg)
# ============================================
[env.staging]
name = "cpa-study-api-stg"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "cpa-study-db-stg"
database_id = "YOUR_STAGING_DATABASE_ID"
migrations_dir = "../../packages/db/migrations"

[[env.staging.r2_buckets]]
binding = "R2"
bucket_name = "YOUR_STAGING_R2_BUCKET"

[[env.staging.durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"

[[env.staging.analytics_engine_datasets]]
binding = "LOGS"
dataset = "api_logs"

[env.staging.vars]
ENVIRONMENT = "staging"
AI_PROVIDER = "vercel-ai"

# ステージング環境シークレット（GitHub Actions経由で設定）
# OPENROUTER_API_KEY
# GOOGLE_CLIENT_ID
# GOOGLE_CLIENT_SECRET
# JWT_SECRET

# ============================================
# 本番環境設定 (releaseブランチ → prod)
# ============================================
[env.production]
name = "cpa-study-api-prod"

[[env.production.d1_databases]]
binding = "DB"
database_name = "cpa-study-db-prod"
database_id = "YOUR_PRODUCTION_DATABASE_ID"
migrations_dir = "../../packages/db/migrations"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "YOUR_PRODUCTION_R2_BUCKET"

[[env.production.durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"

[[env.production.analytics_engine_datasets]]
binding = "LOGS"
dataset = "api_logs"

[env.production.vars]
ENVIRONMENT = "production"
AI_PROVIDER = "vercel-ai"

# 本番環境シークレット（GitHub Actions経由で設定）
# OPENROUTER_API_KEY
# GOOGLE_CLIENT_ID
# GOOGLE_CLIENT_SECRET
# JWT_SECRET
